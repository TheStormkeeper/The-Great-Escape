<?xml version="1.0" encoding="utf-8" ?>
<!DOCTYPE html
    PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<title>The Great Escape: Routine at A228</title>
<meta http-equiv="content-type" content="text/html; charset=utf-8" />
<link rel="stylesheet" type="text/css" href="../TheGreatEscape.css" />

</head>
<body class="Asm-c">
<table class="header">
<tr>
<td class="logo"><a class="link" href="../index.html"><img alt="logo" src="../images/logo.png" /></a></td>
<td class="page-header">Routines</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev"><span class="prev-1">Prev: <a class="link" href="41497.html">A219</a></span></td>
<td class="up">Up: <a class="link" href="../maps/all.html#41512">Map</a></td>
<td class="next"><span class="next-1">Next: <a class="link" href="41572.html">A264</a></span></td>
</tr>
</table>
<div class="description">A228: event_new_red_cross_parcel</div>
<table class="disassembly">
<tr>
<td class="routine-comment" colspan="4">
<div class="details">
<div class="paragraph">
Don't deliver a new red cross parcel while the previous one still exists.
</div>
</div>
<table class="input-0">
<tr class="asm-input-header">
<th colspan="2">Input</th>
</tr>

</table>
<table class="output-0">
<tr class="asm-output-header">
<th colspan="2">Output</th>
</tr>

</table>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="41512"></a>A228</td>
<td class="instruction">LD A,($771D)</td>
<td class="comment-11" rowspan="4">if ((item_structs[item_RED_CROSS_PARCEL].room &amp; itemstruct_ROOM_MASK) != itemstruct_ROOM_MASK) return;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="41515"></a>A22B</td>
<td class="instruction">AND $3F</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="41517"></a>A22D</td>
<td class="instruction">CP $3F</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="41519"></a>A22F</td>
<td class="instruction">RET NZ</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<a name="41520"></a>
<div class="comments">
<div class="paragraph">
Select the next parcel contents -- the first item from the list which does not exist.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="41520"></a>A230</td>
<td class="instruction">LD DE,$A25F</td>
<td class="comment-11" rowspan="1">DE = &amp;red_cross_parcel_contents_list[0];</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="41523"></a>A233</td>
<td class="instruction">LD B,$04</td>
<td class="comment-11" rowspan="1">B = 4; // length of above</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="41525"></a>A235</td>
<td class="instruction">LD A,(DE)</td>
<td class="comment-11" rowspan="1">do { A = *DE;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="41526"></a>A236</td>
<td class="instruction">CALL <a class="link" href="31782.html">$7C26</a></td>
<td class="comment-11" rowspan="1">HL = item_to_itemstruct(A);</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="41529"></a>A239</td>
<td class="instruction">INC HL</td>
<td class="comment-11" rowspan="1">HL++;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="41530"></a>A23A</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-11" rowspan="4">if ((*HL &amp; itemstruct_ROOM_MASK) == itemstruct_ROOM_MASK) goto found;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="41531"></a>A23B</td>
<td class="instruction">AND $3F</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="41533"></a>A23D</td>
<td class="instruction">CP $3F</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="41535"></a>A23F</td>
<td class="instruction">JR Z,$A245</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="41537"></a>A241</td>
<td class="instruction">INC DE</td>
<td class="comment-11" rowspan="1">DE++;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="41538"></a>A242</td>
<td class="instruction">DJNZ $A235</td>
<td class="comment-11" rowspan="1">} while (--B);</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="41540"></a>A244</td>
<td class="instruction">RET</td>
<td class="comment-11" rowspan="1">return;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="41541"></a>A245</td>
<td class="instruction">LD A,(DE)</td>
<td class="comment-11" rowspan="2">found: red_cross_parcel_current_contents = *DE;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="41542"></a>A246</td>
<td class="instruction">LD ($A263),A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="41545"></a>A249</td>
<td class="instruction">LD DE,$771D</td>
<td class="comment-11" rowspan="4">memcpy(&amp;item_structs[item_RED_CROSS_PARCEL].room, red_cross_parcel_reset_data, 6);</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="41548"></a>A24C</td>
<td class="instruction">LD HL,$A259</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="41551"></a>A24F</td>
<td class="instruction">LD BC,$0006</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="41554"></a>A252</td>
<td class="instruction">LDIR</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="41556"></a>A254</td>
<td class="instruction">LD B,$09</td>
<td class="comment-11" rowspan="2">queue_message_for_display(message_RED_CROSS_PARCEL); return; // exit via</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="41558"></a>A256</td>
<td class="instruction">JP <a class="link" href="32021.html">$7D15</a></td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<a name="41561"></a>
<div class="comments">
<div class="paragraph">
red_cross_parcel_reset_data
</div>
<div class="paragraph">
Data to set the parcel object up (room, y, x, ...).
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="41561"></a>A259</td>
<td class="instruction">DEFB $14,$2C,$2C,$0C,$80,$F4</td>
<td class="comment-11" rowspan="1">item_RED_CROSS_PARCEL, 44,44, 0x0C,0x80,0xF4 };</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="41567"></a>A25F</td>
<td class="instruction">DEFB $0E,$00,$05,$0F</td>
<td class="comment-11" rowspan="1">item_t red_cross_parcel_contents_list[] = { item_PURSE, item_WIRESNIPS, item_BRIBE, item_COMPASS };</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="41571"></a>A263</td>
<td class="instruction">DEFB $FF</td>
<td class="comment-11" rowspan="1">red_cross_parcel_current_contents</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev"><span class="prev-1">Prev: <a class="link" href="41497.html">A219</a></span></td>
<td class="up">Up: <a class="link" href="../maps/all.html#41512">Map</a></td>
<td class="next"><span class="next-1">Next: <a class="link" href="41572.html">A264</a></span></td>
</tr>
</table>
<div class="footer">
<div class="release">The incomplete The Great Escape disassembly 20140604</div>
<div class="copyright">&copy; Denton Designs. Ocean. David Thomas.</div>
<div class="created">Created using <a class="link" href="http://pyskool.ca/?page_id=177">SkoolKit</a> 4.0.</div>
</div>
</body>
</html>