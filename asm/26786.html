<?xml version="1.0" encoding="utf-8" ?>
<!DOCTYPE html
    PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="content-type" content="text/html; charset=utf-8" />
<title>The Great Escape: Routine at 68A2</title>
<link rel="stylesheet" type="text/css" href="../TheGreatEscape.css" />
</head>
<body class="disassembly">
<table class="header">
<tr>
<td class="headerLogo"><a class="link" href="../index.html"><img alt="logo" src="../images/logo.png" /></a></td>
<td class="headerText">Routines</td>
</tr>
</table>
<table class="prevNext">
<tr>
<td class="prev">Prev: <a class="link" href="26785.html">68A1</a></td>
<td class="up">Up: <a class="link" href="../maps/all.html#26786">Map</a></td>
<td class="next">Next: <a class="link" href="26868.html">68F4</a></td>
</tr>
</table>
<div class="description">68A2: transition</div>
<table class="disassembly">
<tr>
<td class="routineComment" colspan="3">
<div class="details">
<div class="paragraph">
Looks like it's called to transition to a new room.
</div>
</div>
<table class="input">
<tr>
<td class="register">HL</td>
<td class="registerContents">Pointer to location?</td>
</tr>
<tr>
<td class="register">IY</td>
<td class="registerContents">Pointer to vischar?</td>
</tr>
</table>
</td>
</tr>
<tr>
<td class="label"><a name="26786"></a>68A2</td>
<td class="instruction">EX DE,HL</td>
<td class="comment">EX DE,HL</td>
</tr>
<tr>
<td class="address"><a name="26787"></a>68A3</td>
<td class="instruction">PUSH IY</td>
<td class="comment" rowspan="2">HL = IY;</td>
</tr>
<tr>
<td class="address"><a name="26789"></a>68A5</td>
<td class="instruction">POP HL</td>
</tr>
<tr>
<td class="address"><a name="26790"></a>68A6</td>
<td class="instruction">LD A,L</td>
<td class="comment">A = L; // stash vischar index/offset</td>
</tr>
<tr>
<td class="address"><a name="26791"></a>68A7</td>
<td class="instruction">PUSH AF</td>
<td class="comment">PUSH AF</td>
</tr>
<tr>
<td class="address"><a name="26792"></a>68A8</td>
<td class="instruction">ADD A,$0F</td>
<td class="comment" rowspan="2">L = A + 0x0F; // $8xxF (position on Y axis)</td>
</tr>
<tr>
<td class="address"><a name="26794"></a>68AA</td>
<td class="instruction">LD L,A</td>
</tr>
<tr>
<td class="address"><a name="26795"></a>68AB</td>
<td class="instruction">LD A,(IY+$1C)</td>
<td class="comment">A = IY[0x1C]; // $8x1C (likely room index)</td>
</tr>
<tr>
<td class="address"><a name="26798"></a>68AE</td>
<td class="instruction">AND A</td>
<td class="comment" rowspan="13">if (A == 0) { // outdoors } B = 3; // 3 iterations do { PUSH BC A = *DE++; multiply_by_4(); {    *HL++ = C; } {    *HL++ = B; } POP BC while (--B);</td>
</tr>
<tr>
<td class="address"><a name="26799"></a>68AF</td>
<td class="instruction">JP NZ,$68C3</td>
</tr>
<tr>
<td class="routineComment" colspan="3">
<a name="26802"></a>
<div class="comments">
<div class="paragraph">
Set position on Y axis, X axis and vertical offset (dividing by 4).
</div>
</div>
</td>
</tr>
<tr>
<td class="address">68B2</td>
<td class="instruction">LD B,$03</td>
</tr>
<tr>
<td class="label"><a name="26804"></a>68B4</td>
<td class="instruction">PUSH BC</td>
</tr>
<tr>
<td class="address"><a name="26805"></a>68B5</td>
<td class="instruction">LD A,(DE)</td>
</tr>
<tr>
<td class="address"><a name="26806"></a>68B6</td>
<td class="instruction">CALL <a class="link" href="45717.html">$B295</a></td>
</tr>
<tr>
<td class="address"><a name="26809"></a>68B9</td>
<td class="instruction">LD (HL),C</td>
</tr>
<tr>
<td class="address"><a name="26810"></a>68BA</td>
<td class="instruction">INC L</td>
</tr>
<tr>
<td class="address"><a name="26811"></a>68BB</td>
<td class="instruction">LD (HL),B</td>
</tr>
<tr>
<td class="address"><a name="26812"></a>68BC</td>
<td class="instruction">INC L</td>
</tr>
<tr>
<td class="address"><a name="26813"></a>68BD</td>
<td class="instruction">INC DE</td>
</tr>
<tr>
<td class="address"><a name="26814"></a>68BE</td>
<td class="instruction">POP BC</td>
</tr>
<tr>
<td class="address"><a name="26815"></a>68BF</td>
<td class="instruction">DJNZ $68B4</td>
</tr>
<tr>
<td class="address"><a name="26817"></a>68C1</td>
<td class="instruction">JR $68CE</td>
<td class="comment">else { // indoors</td>
</tr>
<tr>
<td class="routineComment" colspan="3">
<a name="26819"></a>
<div class="comments">
<div class="paragraph">
Set position on Y axis, X axis and vertical offset (copying).
</div>
</div>
</td>
</tr>
<tr>
<td class="label">68C3</td>
<td class="instruction">LD B,$03</td>
<td class="comment">B = 3; // 3 iterations</td>
</tr>
<tr>
<td class="label"><a name="26821"></a>68C5</td>
<td class="instruction">LD A,(DE)</td>
<td class="comment" rowspan="7">do { *HL++ = *DE++; } {    *HL++ = 0; } while (--B);</td>
</tr>
<tr>
<td class="address"><a name="26822"></a>68C6</td>
<td class="instruction">LD (HL),A</td>
</tr>
<tr>
<td class="address"><a name="26823"></a>68C7</td>
<td class="instruction">INC L</td>
</tr>
<tr>
<td class="address"><a name="26824"></a>68C8</td>
<td class="instruction">LD (HL),$00</td>
</tr>
<tr>
<td class="address"><a name="26826"></a>68CA</td>
<td class="instruction">INC L</td>
</tr>
<tr>
<td class="address"><a name="26827"></a>68CB</td>
<td class="instruction">INC DE</td>
</tr>
<tr>
<td class="address"><a name="26828"></a>68CC</td>
<td class="instruction">DJNZ $68C5</td>
</tr>
<tr>
<td class="label"><a name="26830"></a>68CE</td>
<td class="instruction">POP AF</td>
<td class="comment">POP AF</td>
</tr>
<tr>
<td class="address"><a name="26831"></a>68CF</td>
<td class="instruction">LD L,A</td>
<td class="comment">L = A;</td>
</tr>
<tr>
<td class="address"><a name="26832"></a>68D0</td>
<td class="instruction">AND A</td>
<td class="comment" rowspan="3">if (A) { reset_visible_character(); return; } // exit via</td>
</tr>
<tr>
<td class="address"><a name="26833"></a>68D1</td>
<td class="instruction">JP Z,$68D7</td>
</tr>
<tr>
<td class="address"><a name="26836"></a>68D4</td>
<td class="instruction">JP <a class="link" href="50643.html">$C5D3</a></td>
</tr>
<tr>
<td class="routineComment" colspan="3">
<a name="26839"></a>
<div class="comments">
<div class="paragraph">
HL points to the player vischar at this point.
</div>
</div>
</td>
</tr>
<tr>
<td class="label">68D7</td>
<td class="instruction">INC L</td>
<td class="comment" rowspan="2">*++HL &amp;= ~vischar_BYTE1_BIT7; // $8001</td>
</tr>
<tr>
<td class="address"><a name="26840"></a>68D8</td>
<td class="instruction">RES 7,(HL)</td>
</tr>
<tr>
<td class="address"><a name="26842"></a>68DA</td>
<td class="instruction">LD A,($801C)</td>
<td class="comment">A = ($801C); // room index</td>
</tr>
<tr>
<td class="address"><a name="26845"></a>68DD</td>
<td class="instruction">LD ($68A0),A</td>
<td class="comment">room_index = A;</td>
</tr>
<tr>
<td class="address"><a name="26848"></a>68E0</td>
<td class="instruction">AND A</td>
<td class="comment" rowspan="12">if (A == 0) } {  HL += 12; } {  *HL++ = 0x80; // $800D // likely a character direction} {  *HL &amp;= 3;     // $800E // likely a sprite direction } reset_B2FC(); goto squash_stack_goto_main;</td>
</tr>
<tr>
<td class="address"><a name="26849"></a>68E1</td>
<td class="instruction">JP NZ,<a class="link" href="26868.html">$68F4</a></td>
</tr>
<tr>
<td class="address"><a name="26852"></a>68E4</td>
<td class="instruction">LD A,$0C</td>
</tr>
<tr>
<td class="address"><a name="26854"></a>68E6</td>
<td class="instruction">ADD A,L</td>
</tr>
<tr>
<td class="address"><a name="26855"></a>68E7</td>
<td class="instruction">LD L,A</td>
</tr>
<tr>
<td class="address"><a name="26856"></a>68E8</td>
<td class="instruction">LD (HL),$80</td>
</tr>
<tr>
<td class="address"><a name="26858"></a>68EA</td>
<td class="instruction">INC L</td>
</tr>
<tr>
<td class="address"><a name="26859"></a>68EB</td>
<td class="instruction">LD A,(HL)</td>
</tr>
<tr>
<td class="address"><a name="26860"></a>68EC</td>
<td class="instruction">AND $03</td>
</tr>
<tr>
<td class="address"><a name="26862"></a>68EE</td>
<td class="instruction">LD (HL),A</td>
</tr>
<tr>
<td class="address"><a name="26863"></a>68EF</td>
<td class="instruction">CALL <a class="link" href="45820.html">$B2FC</a></td>
</tr>
<tr>
<td class="address"><a name="26866"></a>68F2</td>
<td class="instruction">JR <a class="link" href="26906.html">$691A</a></td>
</tr>
</table>
<table class="prevNext">
<tr>
<td class="prev">Prev: <a class="link" href="26785.html">68A1</a></td>
<td class="up">Up: <a class="link" href="../maps/all.html#26786">Map</a></td>
<td class="next">Next: <a class="link" href="26868.html">68F4</a></td>
</tr>
</table>
<div class="footer">
<div class="release">The incomplete The Great Escape disassembly 20140126</div>
<div class="copyright">&copy; Denton Designs. Ocean. David Thomas.</div>
<div class="created">Created using <a class="link" href="http://pyskool.ca/?page_id=177">SkoolKit</a> 3.6.</div>
</div>
</body>
</html>