<?xml version="1.0" encoding="utf-8" ?>
<!DOCTYPE html
    PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<title>The Great Escape: Routine at 9F21</title>
<meta http-equiv="content-type" content="text/html; charset=utf-8" />
<link rel="stylesheet" type="text/css" href="../skoolkit.css" />
<link rel="stylesheet" type="text/css" href="../TheGreatEscape.css" />

</head>
<body class="Asm-c">
<table class="header">
<tr>
<td class="logo"><a class="link" href="../index.html"><img alt="logo" src="../images/logo.png" /></a></td>
<td class="page-header">Routines</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev"><span class="prev-1">Prev: <a class="link" href="9F15.html">9F15</a></span></td>
<td class="up">Up: <a class="link" href="../maps/all.html#9f21">Map</a></td>
<td class="next"><span class="next-1">Next: <a class="link" href="A007.html">A007</a></span></td>
</tr>
</table>
<div class="description">9F21: In permitted area.</div>
<table class="disassembly">
<tr>
<td class="routine-comment" colspan="4">
<div class="details">
<div class="paragraph">
Used by the routine at <a class="link" href="9D7B.html">9D7B</a>.
</div>
</div>
<table class="input-0">
<tr class="asm-input-header">
<th colspan="2">Input</th>
</tr>

</table>
<table class="output-0">
<tr class="asm-output-header">
<th colspan="2">Output</th>
</tr>

</table>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="9f21"></a>9F21</td>
<td class="instruction">LD HL,$800F</td>
<td class="comment-11" rowspan="1">HL = $800F; // position on X axis</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="9f24"></a>9F24</td>
<td class="instruction">LD DE,$81B8</td>
<td class="comment-11" rowspan="1">DE = &amp;hero_map_position.y; // x/y confusion here - mislabeling</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="9f27"></a>9F27</td>
<td class="instruction">LD A,($68A0)</td>
<td class="comment-11" rowspan="3">if (room_index == 0) &lt;% // outdoors</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="9f2a"></a>9F2A</td>
<td class="instruction">AND A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="9f2b"></a>9F2B</td>
<td class="instruction">JP NZ,$9F49</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<a name="9f2e"></a>
<div class="comments">
<div class="paragraph">
Outdoors.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="9f2e"></a>9F2E</td>
<td class="instruction">CALL <a class="link" href="E542.html">$E542</a></td>
<td class="comment-11" rowspan="1">pos_to_tinypos(HL,DE);</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="9f31"></a>9F31</td>
<td class="instruction">LD HL,($8018)</td>
<td class="comment-11" rowspan="8">if (($8018) &gt;= 0x06C8 || ($801A) &gt;= 0x0448) goto escaped; %&gt;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="9f34"></a>9F34</td>
<td class="instruction">LD DE,$06C8</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="9f37"></a>9F37</td>
<td class="instruction">SBC HL,DE</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="9f39"></a>9F39</td>
<td class="instruction">JP NC,<a class="link" href="A51C.html">$A51C</a></td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="9f3c"></a>9F3C</td>
<td class="instruction">LD HL,($801A)</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="9f3f"></a>9F3F</td>
<td class="instruction">LD DE,$0448</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="9f42"></a>9F42</td>
<td class="instruction">SBC HL,DE</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="9f44"></a>9F44</td>
<td class="instruction">JP NC,<a class="link" href="A51C.html">$A51C</a></td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="9f47"></a>9F47</td>
<td class="instruction">JR $9F51</td>
<td class="comment-11" rowspan="1">else &lt;%</td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<a name="9f49"></a>
<div class="comments">
<div class="paragraph">
Indoors.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="9f49"></a>9F49</td>
<td class="instruction">LDI</td>
<td class="comment-11" rowspan="1">*DE++ = *HL++;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="9f4b"></a>9F4B</td>
<td class="instruction">INC L</td>
<td class="comment-11" rowspan="1">HL++;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="9f4c"></a>9F4C</td>
<td class="instruction">LDI</td>
<td class="comment-11" rowspan="1">*DE++ = *HL++;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="9f4e"></a>9F4E</td>
<td class="instruction">INC L</td>
<td class="comment-11" rowspan="1">HL++;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="9f4f"></a>9F4F</td>
<td class="instruction">LDI</td>
<td class="comment-11" rowspan="1">*DE++ = *HL++; %&gt;</td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<a name="9f51"></a>
<div class="comments">
<div class="paragraph">
Red flag if picking a lock, or cutting wire.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="9f51"></a>9F51</td>
<td class="instruction">LD A,($8001)</td>
<td class="comment-11" rowspan="2">A = ($8001) &amp; (vischar_FLAGS_PICKING_LOCK | vischar_FLAGS_CUTTING_WIRE);</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="9f54"></a>9F54</td>
<td class="instruction">AND $03</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="9f56"></a>9F56</td>
<td class="instruction">JP NZ,$9FF8</td>
<td class="comment-11" rowspan="1">if (A) goto set_flag_red;</td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<a name="9f59"></a>
<div class="comments">
<div class="paragraph">
At night, home room is the only safe place.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="9f59"></a>9F59</td>
<td class="instruction">LD A,($A13D)</td>
<td class="comment-11" rowspan="3">if (clock &gt;= 100) &lt;% // night time</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="9f5c"></a>9F5C</td>
<td class="instruction">CP $64</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="9f5e"></a>9F5E</td>
<td class="instruction">JR C,$9F6B</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="9f60"></a>9F60</td>
<td class="instruction">LD A,($68A0)</td>
<td class="comment-11" rowspan="4">if (room_index == room_2_HUT2LEFT) goto set_flag_green; else goto set_flag_red; %&gt;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="9f63"></a>9F63</td>
<td class="instruction">CP $02</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="9f65"></a>9F65</td>
<td class="instruction">JP Z,$9FDE</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="9f68"></a>9F68</td>
<td class="instruction">JP $9FF8</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="9f6b"></a>9F6B</td>
<td class="instruction">LD A,($A13A)</td>
<td class="comment-11" rowspan="3">if (morale_1) goto set_flag_green;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="9f6e"></a>9F6E</td>
<td class="instruction">AND A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="9f6f"></a>9F6F</td>
<td class="instruction">JP NZ,$9FDE</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="9f72"></a>9F72</td>
<td class="instruction">LD HL,$8002</td>
<td class="comment-11" rowspan="1">HL = $8002; // target location</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="9f75"></a>9F75</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-11" rowspan="2">A = *HL++;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="9f76"></a>9F76</td>
<td class="instruction">INC L</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="9f77"></a>9F77</td>
<td class="instruction">LD C,(HL)</td>
<td class="comment-11" rowspan="1">C = *HL;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="9f78"></a>9F78</td>
<td class="instruction">BIT 7,A</td>
<td class="comment-11" rowspan="3">if (A &amp; vischar_BYTE2_BIT7) C++;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="9f7a"></a>9F7A</td>
<td class="instruction">JR Z,$9F7D</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="9f7c"></a>9F7C</td>
<td class="instruction">INC C</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="9f7d"></a>9F7D</td>
<td class="instruction">CP $FF</td>
<td class="comment-11" rowspan="2">if (A == 0xFF) &lt;%</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="9f7f"></a>9F7F</td>
<td class="instruction">JR NZ,$9F93</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="9f81"></a>9F81</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-11" rowspan="2">A = *HL &amp; 0xF8;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="9f82"></a>9F82</td>
<td class="instruction">AND $F8</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="9f84"></a>9F84</td>
<td class="instruction">CP $08</td>
<td class="comment-11" rowspan="4">if (A == 8) A = 1; else A = 2;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="9f86"></a>9F86</td>
<td class="instruction">LD A,$01</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="9f88"></a>9F88</td>
<td class="instruction">JR Z,$9F8C</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="9f8a"></a>9F8A</td>
<td class="instruction">LD A,$02</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="9f8c"></a>9F8C</td>
<td class="instruction">CALL <a class="link" href="A007.html">$A007</a></td>
<td class="comment-11" rowspan="1">in_permitted_area_end_bit();</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="9f8f"></a>9F8F</td>
<td class="instruction">JR Z,$9FDE</td>
<td class="comment-11" rowspan="2">if (Z) goto set_flag_green; else goto set_flag_red; %&gt;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="9f91"></a>9F91</td>
<td class="instruction">JR $9FF8</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="9f93"></a>9F93</td>
<td class="instruction">AND $7F</td>
<td class="comment-11" rowspan="1">else &lt;% A &amp;= 0x7F;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="9f95"></a>9F95</td>
<td class="instruction">LD HL,$9EE4</td>
<td class="comment-11" rowspan="1">HL = &amp;byte_to_pointer[0]; // table mapping bytes to offsets</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="9f98"></a>9F98</td>
<td class="instruction">LD B,$07</td>
<td class="comment-11" rowspan="1">B = 7; // 7 iterations</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="9f9a"></a>9F9A</td>
<td class="instruction">CP (HL)</td>
<td class="comment-11" rowspan="3">do &lt;% if (A == *HL++) goto found;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="9f9b"></a>9F9B</td>
<td class="instruction">INC HL</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="9f9c"></a>9F9C</td>
<td class="instruction">JR Z,$9FA4</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="9f9e"></a>9F9E</td>
<td class="instruction">INC HL</td>
<td class="comment-11" rowspan="2">HL += 2;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="9f9f"></a>9F9F</td>
<td class="instruction">INC HL</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="9fa0"></a>9FA0</td>
<td class="instruction">DJNZ $9F9A</td>
<td class="comment-11" rowspan="1">%&gt; while (--B);</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="9fa2"></a>9FA2</td>
<td class="instruction">JR $9FDE</td>
<td class="comment-11" rowspan="1">goto set_flag_green; %&gt;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="9fa4"></a>9FA4</td>
<td class="instruction">LD E,(HL)</td>
<td class="comment-11" rowspan="2">found: E = *HL++; // fetch offset</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="9fa5"></a>9FA5</td>
<td class="instruction">INC HL</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="9fa6"></a>9FA6</td>
<td class="instruction">LD D,(HL)</td>
<td class="comment-11" rowspan="1">D = *HL;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="9fa7"></a>9FA7</td>
<td class="instruction">PUSH DE</td>
<td class="comment-11" rowspan="1">PUSH DE</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="9fa8"></a>9FA8</td>
<td class="instruction">POP HL</td>
<td class="comment-11" rowspan="1">POP HL   // HL = DE;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="9fa9"></a>9FA9</td>
<td class="instruction">LD B,$00</td>
<td class="comment-11" rowspan="1">B = 0;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="9fab"></a>9FAB</td>
<td class="instruction">ADD HL,BC</td>
<td class="comment-11" rowspan="1">HL += BC;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="9fac"></a>9FAC</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-11" rowspan="1">A = *HL;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="9fad"></a>9FAD</td>
<td class="instruction">PUSH DE</td>
<td class="comment-11" rowspan="1">PUSH DE</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="9fae"></a>9FAE</td>
<td class="instruction">CALL <a class="link" href="A007.html">$A007</a></td>
<td class="comment-11" rowspan="1">in_permitted_area_end_bit();</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="9fb1"></a>9FB1</td>
<td class="instruction">POP HL</td>
<td class="comment-11" rowspan="1">POP HL</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="9fb2"></a>9FB2</td>
<td class="instruction">JR Z,$9FDE</td>
<td class="comment-11" rowspan="1">JR Z,set_flag_green;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="9fb4"></a>9FB4</td>
<td class="instruction">LD A,($8002)</td>
<td class="comment-11" rowspan="1">A = $8002;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="9fb7"></a>9FB7</td>
<td class="instruction">BIT 7,A</td>
<td class="comment-11" rowspan="3">if (A &amp; vischar_BYTE2_BIT7) HL++;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="9fb9"></a>9FB9</td>
<td class="instruction">JR Z,$9FBC</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="9fbb"></a>9FBB</td>
<td class="instruction">INC HL</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="9fbc"></a>9FBC</td>
<td class="instruction">LD BC,$0000</td>
<td class="comment-11" rowspan="1">BC = 0; // counter?</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="9fbf"></a>9FBF</td>
<td class="instruction">PUSH BC</td>
<td class="comment-11" rowspan="1">for (;;) &lt;% PUSH BC</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="9fc0"></a>9FC0</td>
<td class="instruction">PUSH HL</td>
<td class="comment-11" rowspan="1">PUSH HL</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="9fc1"></a>9FC1</td>
<td class="instruction">ADD HL,BC</td>
<td class="comment-11" rowspan="1">HL += BC;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="9fc2"></a>9FC2</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-11" rowspan="1">A = *HL;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="9fc3"></a>9FC3</td>
<td class="instruction">CP $FF</td>
<td class="comment-11" rowspan="2">if (A == 255) goto pop_and_set_flag_red; // hit end of list</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="9fc5"></a>9FC5</td>
<td class="instruction">JR Z,$9FDA</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="9fc7"></a>9FC7</td>
<td class="instruction">CALL <a class="link" href="A007.html">$A007</a></td>
<td class="comment-11" rowspan="1">in_permitted_area_end_bit();</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="9fca"></a>9FCA</td>
<td class="instruction">POP HL</td>
<td class="comment-11" rowspan="1">POP HL</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="9fcb"></a>9FCB</td>
<td class="instruction">POP BC</td>
<td class="comment-11" rowspan="1">POP BC</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="9fcc"></a>9FCC</td>
<td class="instruction">JR Z,$9FD1</td>
<td class="comment-11" rowspan="1">if (Z) goto set_target_then_set_flag_green; // if (Z) break; equivalent?</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="9fce"></a>9FCE</td>
<td class="instruction">INC C</td>
<td class="comment-11" rowspan="1">BC++;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="9fcf"></a>9FCF</td>
<td class="instruction">JR $9FBF</td>
<td class="comment-11" rowspan="1">%&gt;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="9fd1"></a>9FD1</td>
<td class="instruction">LD A,($8002)</td>
<td class="comment-11" rowspan="2">set_target_then_set_flag_green: B = $8002;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="9fd4"></a>9FD4</td>
<td class="instruction">LD B,A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="9fd5"></a>9FD5</td>
<td class="instruction">CALL <a class="link" href="A33F.html">$A33F</a></td>
<td class="comment-11" rowspan="1">set_hero_target_location(); // uses B, C</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="9fd8"></a>9FD8</td>
<td class="instruction">JR $9FDE</td>
<td class="comment-11" rowspan="1">goto set_flag_green;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="9fda"></a>9FDA</td>
<td class="instruction">POP BC</td>
<td class="comment-11" rowspan="1">pop_and_set_flag_red: POP BC</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="9fdb"></a>9FDB</td>
<td class="instruction">POP HL</td>
<td class="comment-11" rowspan="1">POP HL</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="9fdc"></a>9FDC</td>
<td class="instruction">JR $9FF8</td>
<td class="comment-11" rowspan="1">goto set_flag_red;</td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<a name="9fde"></a>
<div class="comments">
<div class="paragraph">
Green flag code path.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="9fde"></a>9FDE</td>
<td class="instruction">XOR A</td>
<td class="comment-11" rowspan="1">set_flag_green: A = 0; // red_flag = 0</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="9fdf"></a>9FDF</td>
<td class="instruction">LD C,$44</td>
<td class="comment-11" rowspan="1">C = attribute_BRIGHT_GREEN_OVER_BLACK;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="9fe1"></a>9FE1</td>
<td class="instruction">LD ($A138),A</td>
<td class="comment-11" rowspan="1">flag_select: red_flag = A;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="9fe4"></a>9FE4</td>
<td class="instruction">LD A,C</td>
<td class="comment-11" rowspan="1">A = C;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="9fe5"></a>9FE5</td>
<td class="instruction">LD HL,$5842</td>
<td class="comment-11" rowspan="1">HL = $5842; // first morale flag attribute byte</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="9fe8"></a>9FE8</td>
<td class="instruction">CP (HL)</td>
<td class="comment-11" rowspan="2">if (A == *HL) return; // flag already correct colour</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="9fe9"></a>9FE9</td>
<td class="instruction">RET Z</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="9fea"></a>9FEA</td>
<td class="instruction">CP $44</td>
<td class="comment-11" rowspan="2">if (A == attribute_BRIGHT_GREEN_OVER_BLACK) &lt;%</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="9fec"></a>9FEC</td>
<td class="instruction">JP NZ,<a class="link" href="A071.html">$A071</a></td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="9fef"></a>9FEF</td>
<td class="instruction">LD A,$FF</td>
<td class="comment-11" rowspan="2">bell = bell_STOP; // silence bell</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="9ff1"></a>9FF1</td>
<td class="instruction">LD ($A130),A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="9ff4"></a>9FF4</td>
<td class="instruction">LD A,C</td>
<td class="comment-11" rowspan="1">A = C; %&gt;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="9ff5"></a>9FF5</td>
<td class="instruction">JP <a class="link" href="A071.html">$A071</a></td>
<td class="comment-11" rowspan="1">goto set_morale_flag_screen_attributes; // exit via</td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<a name="9ff8"></a>
<div class="comments">
<div class="paragraph">
Red flag code path.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="9ff8"></a>9FF8</td>
<td class="instruction">LD C,$42</td>
<td class="comment-11" rowspan="1">set_flag_red: C = attribute_BRIGHT_RED_OVER_BLACK;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="9ffa"></a>9FFA</td>
<td class="instruction">LD A,($5842)</td>
<td class="comment-11" rowspan="1">A = ($5842); // first morale flag attribute byte</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="9ffd"></a>9FFD</td>
<td class="instruction">CP C</td>
<td class="comment-11" rowspan="2">if (A == C) return; // flag already red</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="9ffe"></a>9FFE</td>
<td class="instruction">RET Z</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="9fff"></a>9FFF</td>
<td class="instruction">XOR A</td>
<td class="comment-11" rowspan="2">($800D) = 0; // "tunnel related" thing</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="a000"></a>A000</td>
<td class="instruction">LD ($800D),A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="a003"></a>A003</td>
<td class="instruction">LD A,$FF</td>
<td class="comment-11" rowspan="1">A = 255; // red_flag</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="a005"></a>A005</td>
<td class="instruction">JR $9FE1</td>
<td class="comment-11" rowspan="1">goto flag_select;</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev"><span class="prev-1">Prev: <a class="link" href="9F15.html">9F15</a></span></td>
<td class="up">Up: <a class="link" href="../maps/all.html#9f21">Map</a></td>
<td class="next"><span class="next-1">Next: <a class="link" href="A007.html">A007</a></span></td>
</tr>
</table>
<div class="footer">
<div class="release">The incomplete The Great Escape disassembly 20150622</div>
<div class="copyright">&copy; Denton Designs. Ocean. David Thomas.</div>
<div class="created">Created using <a class="link" href="http://skoolkit.ca/">SkoolKit</a> 4.4.</div>
</div>
</body>
</html>