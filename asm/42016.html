<?xml version="1.0" encoding="utf-8" ?>
<!DOCTYPE html
    PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<title>The Great Escape: Routine at A420</title>
<link rel="stylesheet" type="text/css" href="../TheGreatEscape.css" />
</head>
<body class="disassembly">
<table class="header">
<tr>
<td class="headerLogo"><a class="link" href="../index.html"><img src="../images/logo.png" alt="The Great Escape" /></a></td>
<td class="headerText">Routines</td>
</tr>
</table>
<table class="prevNext">
<tr>
<td class="prev">Prev: <a class="link" href="41976.html">A3F8</a></td>
<td class="up">Up: <a class="link" href="../maps/all.html#42016">Map</a></td>
<td class="next">Next: <a class="link" href="42111.html">A47F</a></td>
</tr>
</table>
<div class="description">A420: character_sits</div>
<table class="disassembly">
<tr>
<td class="routineComment" colspan="3">
<div class="details">
<div class="paragraph">
Used by the routine at <a class="link" href="51142.html">C7C6</a>.
</div>
</div>
<table class="input">
<tr>
<td class="register">A</td>
<td class="registerContents">Character.</td>
</tr>
<tr>
<td class="register">HL</td>
<td class="registerContents">?</td>
</tr>
</table>
</td>
</tr>
<tr>
<td class="label"><a name="42016"></a>A420</td>
<td class="instruction">PUSH AF</td>
<td class="comment">PUSH AF</td>
</tr>
<tr>
<td class="address"><a name="42017"></a>A421</td>
<td class="instruction">EX DE,HL</td>
<td class="comment">EX DE,HL</td>
</tr>
<tr>
<td class="address"><a name="42018"></a>A422</td>
<td class="instruction">SUB $12</td>
<td class="comment">A -= 18; // first three characters</td>
</tr>
<tr>
<td class="address"><a name="42020"></a>A424</td>
<td class="instruction">LD HL,$6F4F</td>
<td class="comment">HL = &amp;roomdef_25_breakfast.bench_D;</td>
</tr>
<tr>
<td class="address"><a name="42023"></a>A427</td>
<td class="instruction">CP $03</td>
<td class="comment" rowspan="4">if (A &gt;= 3) { // second three characters } HL = &amp;roomdef_23_breakfast.bench_A; A -= 3;</td>
</tr>
<tr>
<td class="address"><a name="42025"></a>A429</td>
<td class="instruction">JR C,$A430</td>
</tr>
<tr>
<td class="address"><a name="42027"></a>A42B</td>
<td class="instruction">LD HL,$6F17</td>
</tr>
<tr>
<td class="address"><a name="42030"></a>A42E</td>
<td class="instruction">SUB $03</td>
</tr>
<tr>
<td class="routineComment" colspan="3">
<a name="42032"></a>
<div class="comments">
<div class="paragraph">
Poke object.
</div>
</div>
</td>
</tr>
<tr>
<td class="label">A430</td>
<td class="instruction">LD C,A</td>
<td class="comment" rowspan="6">HL += A * 3;</td>
</tr>
<tr>
<td class="address"><a name="42033"></a>A431</td>
<td class="instruction">ADD A,A</td>
</tr>
<tr>
<td class="address"><a name="42034"></a>A432</td>
<td class="instruction">ADD A,C</td>
</tr>
<tr>
<td class="address"><a name="42035"></a>A433</td>
<td class="instruction">LD B,$00</td>
</tr>
<tr>
<td class="address"><a name="42037"></a>A435</td>
<td class="instruction">LD C,A</td>
</tr>
<tr>
<td class="address"><a name="42038"></a>A436</td>
<td class="instruction">ADD HL,BC</td>
</tr>
<tr>
<td class="address"><a name="42039"></a>A437</td>
<td class="instruction">LD (HL),$05</td>
<td class="comment">*HL = interiorobject_PRISONER_SAT_DOWN_MID_TABLE;</td>
</tr>
<tr>
<td class="address"><a name="42041"></a>A439</td>
<td class="instruction">POP AF</td>
<td class="comment">POP AF</td>
</tr>
<tr>
<td class="address"><a name="42042"></a>A43A</td>
<td class="instruction">LD C,$19</td>
<td class="comment">C = room_25_breakfast;</td>
</tr>
<tr>
<td class="address"><a name="42044"></a>A43C</td>
<td class="instruction">CP $15</td>
<td class="comment" rowspan="3">if (A &gt;= character_21_prisoner) C = room_23_breakfast;</td>
</tr>
<tr>
<td class="address"><a name="42046"></a>A43E</td>
<td class="instruction">JR C,$A462</td>
</tr>
<tr>
<td class="address"><a name="42048"></a>A440</td>
<td class="instruction">LD C,$17</td>
</tr>
<tr>
<td class="address"><a name="42050"></a>A442</td>
<td class="instruction">JR $A462</td>
<td class="comment">goto character_sit_sleep_common;</td>
</tr>
<tr>
<td class="routineComment" colspan="3">
<a name="42052"></a>
<div class="comments">
<div class="paragraph">
character_sleeps
</div>
</div>
</td>
</tr>
<tr>
<td class="label">A444</td>
<td class="instruction">PUSH AF</td>
<td class="comment">PUSH AF</td>
</tr>
<tr>
<td class="address"><a name="42053"></a>A445</td>
<td class="instruction">SUB $07</td>
<td class="comment" rowspan="2">A -= 7;</td>
</tr>
<tr>
<td class="address"><a name="42055"></a>A447</td>
<td class="instruction">ADD A,A</td>
</tr>
<tr>
<td class="address"><a name="42056"></a>A448</td>
<td class="instruction">EX DE,HL</td>
<td class="comment">EX DE,HL</td>
</tr>
<tr>
<td class="routineComment" colspan="3">
<a name="42057"></a>
<div class="comments">
<div class="paragraph">
Poke object.
</div>
</div>
</td>
</tr>
<tr>
<td class="address">A449</td>
<td class="instruction">LD C,A</td>
<td class="comment" rowspan="7">BC = beds[A];</td>
</tr>
<tr>
<td class="address"><a name="42058"></a>A44A</td>
<td class="instruction">LD B,$00</td>
</tr>
<tr>
<td class="address"><a name="42060"></a>A44C</td>
<td class="instruction">LD HL,$6B79</td>
</tr>
<tr>
<td class="address"><a name="42063"></a>A44F</td>
<td class="instruction">ADD HL,BC</td>
</tr>
<tr>
<td class="address"><a name="42064"></a>A450</td>
<td class="instruction">LD C,(HL)</td>
</tr>
<tr>
<td class="address"><a name="42065"></a>A451</td>
<td class="instruction">INC HL</td>
</tr>
<tr>
<td class="address"><a name="42066"></a>A452</td>
<td class="instruction">LD B,(HL)</td>
</tr>
<tr>
<td class="address"><a name="42067"></a>A453</td>
<td class="instruction">LD A,$17</td>
<td class="comment" rowspan="2">*BC = interiorobject_OCCUPIED_BED;</td>
</tr>
<tr>
<td class="address"><a name="42069"></a>A455</td>
<td class="instruction">LD (BC),A</td>
</tr>
<tr>
<td class="address"><a name="42070"></a>A456</td>
<td class="instruction">POP AF</td>
<td class="comment">POP AF</td>
</tr>
<tr>
<td class="address"><a name="42071"></a>A457</td>
<td class="instruction">CP $0A</td>
<td class="comment" rowspan="2">if (A &lt; character_10_prisoner)</td>
</tr>
<tr>
<td class="address"><a name="42073"></a>A459</td>
<td class="instruction">JP NC,$A460</td>
</tr>
<tr>
<td class="address"><a name="42076"></a>A45C</td>
<td class="instruction">LD C,$03</td>
<td class="comment">C = room_3_hut2_right;</td>
</tr>
<tr>
<td class="address"><a name="42078"></a>A45E</td>
<td class="instruction">JR $A462</td>
<td class="comment">else</td>
</tr>
<tr>
<td class="label"><a name="42080"></a>A460</td>
<td class="instruction">LD C,$05</td>
<td class="comment">C = room_5_hut3_right;</td>
</tr>
<tr>
<td class="routineComment" colspan="3">
<a name="42082"></a>
<div class="comments">
<div class="paragraph">
(common end of above two routines)
</div>
<div class="paragraph">
I:C Character?
</div>
<div class="paragraph">
I:DE Pointer to ?
</div>
</div>
</td>
</tr>
<tr>
<td class="label">A462</td>
<td class="instruction">EX DE,HL</td>
<td class="comment">character_sit_sleep_common: EX DE,HL</td>
</tr>
<tr>
<td class="address"><a name="42083"></a>A463</td>
<td class="instruction">LD (HL),$00</td>
<td class="comment">*HL = 0;  // $8022, $76B8, $76BF, $76A3  (can be vischar OR characterstruct - weird)</td>
</tr>
<tr>
<td class="address"><a name="42085"></a>A465</td>
<td class="instruction">EX AF,AF'</td>
<td class="comment">EX AF,AF'</td>
</tr>
<tr>
<td class="address"><a name="42086"></a>A466</td>
<td class="instruction">LD A,($68A0)</td>
<td class="comment" rowspan="9">if (room_index != C) } {  HL -= 4; } *HL = 255; return;</td>
</tr>
<tr>
<td class="address"><a name="42089"></a>A469</td>
<td class="instruction">CP C</td>
</tr>
<tr>
<td class="address"><a name="42090"></a>A46A</td>
<td class="instruction">JR Z,$A473</td>
</tr>
<tr>
<td class="address"><a name="42092"></a>A46C</td>
<td class="instruction">DEC HL</td>
</tr>
<tr>
<td class="address"><a name="42093"></a>A46D</td>
<td class="instruction">DEC HL</td>
</tr>
<tr>
<td class="address"><a name="42094"></a>A46E</td>
<td class="instruction">DEC HL</td>
</tr>
<tr>
<td class="address"><a name="42095"></a>A46F</td>
<td class="instruction">DEC HL</td>
</tr>
<tr>
<td class="address"><a name="42096"></a>A470</td>
<td class="instruction">LD (HL),$FF</td>
</tr>
<tr>
<td class="address"><a name="42098"></a>A472</td>
<td class="instruction">RET</td>
</tr>
<tr>
<td class="routineComment" colspan="3">
<a name="42099"></a>
<div class="comments">
<div class="paragraph">
Force a refresh.
</div>
</div>
</td>
</tr>
<tr>
<td class="label">A473</td>
<td class="instruction">LD A,L</td>
<td class="comment" rowspan="3">HL += 26;</td>
</tr>
<tr>
<td class="address"><a name="42100"></a>A474</td>
<td class="instruction">ADD A,$1A</td>
</tr>
<tr>
<td class="address"><a name="42102"></a>A476</td>
<td class="instruction">LD L,A</td>
</tr>
<tr>
<td class="address"><a name="42103"></a>A477</td>
<td class="instruction">LD (HL),$FF</td>
<td class="comment">*HL = 255;</td>
</tr>
<tr>
<td class="routineComment" colspan="3">
<a name="42105"></a>
<div class="comments">
<div class="paragraph">
This entry point is used by the routine at <a class="link" href="42121.html">A489</a>.
</div>
</div>
</td>
</tr>
<tr>
<td class="label">A479</td>
<td class="instruction">CALL <a class="link" href="27189.html">$6A35</a></td>
<td class="comment">select_room_and_plot: setup_room(); // make this into its own function</td>
</tr>
<tr>
<td class="address"><a name="42108"></a>A47C</td>
<td class="instruction">JP <a class="link" href="27458.html">$6B42</a></td>
<td class="comment">plot_indoor_tiles(); return;</td>
</tr>
</table>
<table class="prevNext">
<tr>
<td class="prev">Prev: <a class="link" href="41976.html">A3F8</a></td>
<td class="up">Up: <a class="link" href="../maps/all.html#42016">Map</a></td>
<td class="next">Next: <a class="link" href="42111.html">A47F</a></td>
</tr>
</table>
<div class="footer">
<div class="release">The incomplete The Great Escape disassembly 20130902</div>
<div class="copyright">&copy; Denton Designs. Ocean. David Thomas.</div>
<div class="created">Created using <a class="link" href="http://pyskool.ca/?page_id=177">SkoolKit</a> 3.3.2.</div>
</div>
</body>
</html>