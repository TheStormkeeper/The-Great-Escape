<?xml version="1.0" encoding="utf-8" ?>
<!DOCTYPE html
    PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<title>The Great Escape: Routine at B89C</title>
<meta http-equiv="content-type" content="text/html; charset=utf-8" />
<link rel="stylesheet" type="text/css" href="../skoolkit.css" />
<link rel="stylesheet" type="text/css" href="../TheGreatEscape.css" />

</head>
<body class="Asm-c">
<table class="header">
<tr>
<td class="logo"><a class="link" href="../index.html"><img alt="logo" src="../images/logo.png" /></a></td>
<td class="page-header">Routines</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev"><span class="prev-1">Prev: <a class="link" href="47206.html">B866</a></span></td>
<td class="up">Up: <a class="link" href="../maps/all.html#47260">Map</a></td>
<td class="next"><span class="next-1">Next: <a class="link" href="47382.html">B916</a></span></td>
</tr>
</table>
<div class="description">B89C: locate_thing_to_plot</div>
<table class="disassembly">
<tr>
<td class="routine-comment" colspan="4">
<div class="details">
<div class="paragraph">
Used by the routine at <a class="link" href="47206.html">B866</a>.
</div>
<div class="paragraph">
Locates a vischar or item to plot.
</div>
</div>
<table class="input-0">
<tr class="asm-input-header">
<th colspan="2">Input</th>
</tr>

</table>
<table class="output-0">
<tr class="asm-output-header">
<th colspan="2">Output</th>
</tr>

</table>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="47260"></a>B89C</td>
<td class="instruction">LD BC,$0000</td>
<td class="comment-11" rowspan="1">BC = 0;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="47263"></a>B89F</td>
<td class="instruction">LD D,C</td>
<td class="comment-11" rowspan="2">DE = 0;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="47264"></a>B8A0</td>
<td class="instruction">LD E,C</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="47265"></a>B8A1</td>
<td class="instruction">LD A,$FF</td>
<td class="comment-11" rowspan="1">A = 0xFF;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="47267"></a>B8A3</td>
<td class="instruction">EX AF,AF'</td>
<td class="comment-11" rowspan="1">EX AF,AF'</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="47268"></a>B8A4</td>
<td class="instruction">EXX</td>
<td class="comment-11" rowspan="1">EXX</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="47269"></a>B8A5</td>
<td class="instruction">LD DE,$0000</td>
<td class="comment-11" rowspan="1">DE = 0;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="47272"></a>B8A8</td>
<td class="instruction">LD BC,$0820</td>
<td class="comment-11" rowspan="1">BC = 0x0820; // B = 8 iterations, C = stride, 32</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="47275"></a>B8AB</td>
<td class="instruction">LD HL,$8007</td>
<td class="comment-11" rowspan="1">HL = $8007; // vischar byte7</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="47278"></a>B8AE</td>
<td class="instruction">BIT 7,(HL)</td>
<td class="comment-11" rowspan="2">do &lt;% if ((*HL &amp; vischar_BYTE7_BIT7) == 0) goto next;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="47280"></a>B8B0</td>
<td class="instruction">JR Z,$B8F7</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="47282"></a>B8B2</td>
<td class="instruction">PUSH HL</td>
<td class="comment-11" rowspan="1">PUSH HL</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="47283"></a>B8B3</td>
<td class="instruction">PUSH BC</td>
<td class="comment-11" rowspan="1">PUSH BC</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="47284"></a>B8B4</td>
<td class="instruction">LD A,$08</td>
<td class="comment-11" rowspan="3">HL += 8; // $8007 + 8 = $800F</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="47286"></a>B8B6</td>
<td class="instruction">ADD A,L</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="47287"></a>B8B7</td>
<td class="instruction">LD L,A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="47288"></a>B8B8</td>
<td class="instruction">LD C,(HL)</td>
<td class="comment-11" rowspan="2">C = *HL++;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="47289"></a>B8B9</td>
<td class="instruction">INC L</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="47290"></a>B8BA</td>
<td class="instruction">LD B,(HL)</td>
<td class="comment-11" rowspan="1">B = *HL;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="47291"></a>B8BB</td>
<td class="instruction">INC BC</td>
<td class="comment-11" rowspan="4">BC += 4;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="47292"></a>B8BC</td>
<td class="instruction">INC BC</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="47293"></a>B8BD</td>
<td class="instruction">INC BC</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="47294"></a>B8BE</td>
<td class="instruction">INC BC</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="47295"></a>B8BF</td>
<td class="instruction">PUSH BC</td>
<td class="comment-11" rowspan="1">PUSH BC</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="47296"></a>B8C0</td>
<td class="instruction">EXX</td>
<td class="comment-11" rowspan="1">EXX</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="47297"></a>B8C1</td>
<td class="instruction">POP HL</td>
<td class="comment-11" rowspan="1">POP HL</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="47298"></a>B8C2</td>
<td class="instruction">SBC HL,BC</td>
<td class="comment-11" rowspan="1">SBC HL,BC</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="47300"></a>B8C4</td>
<td class="instruction">EXX</td>
<td class="comment-11" rowspan="1">EXX</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="47301"></a>B8C5</td>
<td class="instruction">JR C,$B8F5</td>
<td class="comment-11" rowspan="1">JR C,pop_next</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="47303"></a>B8C7</td>
<td class="instruction">INC L</td>
<td class="comment-11" rowspan="1">HL++;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="47304"></a>B8C8</td>
<td class="instruction">LD C,(HL)</td>
<td class="comment-11" rowspan="2">C = *HL++;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="47305"></a>B8C9</td>
<td class="instruction">INC L</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="47306"></a>B8CA</td>
<td class="instruction">LD B,(HL)</td>
<td class="comment-11" rowspan="1">B = *HL;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="47307"></a>B8CB</td>
<td class="instruction">INC BC</td>
<td class="comment-11" rowspan="4">BC += 4;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="47308"></a>B8CC</td>
<td class="instruction">INC BC</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="47309"></a>B8CD</td>
<td class="instruction">INC BC</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="47310"></a>B8CE</td>
<td class="instruction">INC BC</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="47311"></a>B8CF</td>
<td class="instruction">PUSH BC</td>
<td class="comment-11" rowspan="1">PUSH BC</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="47312"></a>B8D0</td>
<td class="instruction">EXX</td>
<td class="comment-11" rowspan="1">EXX</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="47313"></a>B8D1</td>
<td class="instruction">POP HL</td>
<td class="comment-11" rowspan="1">POP HL</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="47314"></a>B8D2</td>
<td class="instruction">SBC HL,DE</td>
<td class="comment-11" rowspan="1">SBC HL,DE</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="47316"></a>B8D4</td>
<td class="instruction">EXX</td>
<td class="comment-11" rowspan="1">EXX</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="47317"></a>B8D5</td>
<td class="instruction">JR C,$B8F5</td>
<td class="comment-11" rowspan="1">JR C,pop_next</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="47319"></a>B8D7</td>
<td class="instruction">INC L</td>
<td class="comment-11" rowspan="1">HL++;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="47320"></a>B8D8</td>
<td class="instruction">POP BC</td>
<td class="comment-11" rowspan="1">POP BC</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="47321"></a>B8D9</td>
<td class="instruction">PUSH BC</td>
<td class="comment-11" rowspan="1">PUSH BC</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="47322"></a>B8DA</td>
<td class="instruction">LD A,$08</td>
<td class="comment-11" rowspan="2">A = 8 - B;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="47324"></a>B8DC</td>
<td class="instruction">SUB B</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="47325"></a>B8DD</td>
<td class="instruction">EX AF,AF'</td>
<td class="comment-11" rowspan="1">EX AF,AF'  // unpaired</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="47326"></a>B8DE</td>
<td class="instruction">LD E,(HL)</td>
<td class="comment-11" rowspan="2">E = *HL++;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="47327"></a>B8DF</td>
<td class="instruction">INC L</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="47328"></a>B8E0</td>
<td class="instruction">LD D,(HL)</td>
<td class="comment-11" rowspan="1">D = *HL;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="47329"></a>B8E1</td>
<td class="instruction">PUSH HL</td>
<td class="comment-11" rowspan="1">PUSH HL</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="47330"></a>B8E2</td>
<td class="instruction">EXX</td>
<td class="comment-11" rowspan="1">EXX</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="47331"></a>B8E3</td>
<td class="instruction">POP HL</td>
<td class="comment-11" rowspan="1">POP HL</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="47332"></a>B8E4</td>
<td class="instruction">DEC L</td>
<td class="comment-11" rowspan="2">L -= 2;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="47333"></a>B8E5</td>
<td class="instruction">DEC L</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="47334"></a>B8E6</td>
<td class="instruction">LD D,(HL)</td>
<td class="comment-11" rowspan="2">D = *HL--;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="47335"></a>B8E7</td>
<td class="instruction">DEC L</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="47336"></a>B8E8</td>
<td class="instruction">LD E,(HL)</td>
<td class="comment-11" rowspan="2">E = *HL--;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="47337"></a>B8E9</td>
<td class="instruction">DEC L</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="47338"></a>B8EA</td>
<td class="instruction">LD B,(HL)</td>
<td class="comment-11" rowspan="2">B = *HL--;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="47339"></a>B8EB</td>
<td class="instruction">DEC L</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="47340"></a>B8EC</td>
<td class="instruction">LD C,(HL)</td>
<td class="comment-11" rowspan="1">C = *HL;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="47341"></a>B8ED</td>
<td class="instruction">LD A,L</td>
<td class="comment-11" rowspan="3">HL -= 15;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="47342"></a>B8EE</td>
<td class="instruction">SUB $0F</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="47344"></a>B8F0</td>
<td class="instruction">LD L,A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="47345"></a>B8F1</td>
<td class="instruction">PUSH HL</td>
<td class="comment-11" rowspan="2">IY = HL;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="47346"></a>B8F2</td>
<td class="instruction">POP IY</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="47348"></a>B8F4</td>
<td class="instruction">EXX</td>
<td class="comment-11" rowspan="1">EXX</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="47349"></a>B8F5</td>
<td class="instruction">POP BC</td>
<td class="comment-11" rowspan="1">pop_next: POP BC</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="47350"></a>B8F6</td>
<td class="instruction">POP HL</td>
<td class="comment-11" rowspan="1">POP HL</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="47351"></a>B8F7</td>
<td class="instruction">LD A,L</td>
<td class="comment-11" rowspan="3">next: HL += C;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="47352"></a>B8F8</td>
<td class="instruction">ADD A,C</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="47353"></a>B8F9</td>
<td class="instruction">LD L,A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="47354"></a>B8FA</td>
<td class="instruction">DJNZ $B8AE</td>
<td class="comment-11" rowspan="1">%&gt; while (--B);</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="47356"></a>B8FC</td>
<td class="instruction">CALL <a class="link" href="56299.html">$DBEB</a></td>
<td class="comment-11" rowspan="1">sub_DBEB();</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="47359"></a>B8FF</td>
<td class="instruction">EX AF,AF'</td>
<td class="comment-11" rowspan="1">EX AF,AF' // return value</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="47360"></a>B900</td>
<td class="instruction">BIT 7,A</td>
<td class="comment-11" rowspan="2">if (A &amp; (1&lt;&lt;7)) return;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="47362"></a>B902</td>
<td class="instruction">RET NZ</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="47363"></a>B903</td>
<td class="instruction">PUSH IY</td>
<td class="comment-11" rowspan="2">HL = IY;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="47365"></a>B905</td>
<td class="instruction">POP HL</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="47366"></a>B906</td>
<td class="instruction">BIT 6,A</td>
<td class="comment-11" rowspan="2">if ((A &amp; (1&lt;&lt;6)) == 0) &lt;%</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="47368"></a>B908</td>
<td class="instruction">JR NZ,$B90F</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="47370"></a>B90A</td>
<td class="instruction">RES 7,(IY+$07)</td>
<td class="comment-11" rowspan="1">IY[7] &amp;= ~vischar_BYTE7_BIT7;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="47374"></a>B90E</td>
<td class="instruction">RET</td>
<td class="comment-11" rowspan="1">return; %&gt;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="47375"></a>B90F</td>
<td class="instruction">INC HL</td>
<td class="comment-11" rowspan="2">else &lt;% HL[1] &amp;= ~itemstruct_ROOM_FLAG_BIT6; // looks wrong: HL points to a vischar here</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="47376"></a>B910</td>
<td class="instruction">RES 6,(HL)</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="47378"></a>B912</td>
<td class="instruction">BIT 6,(HL)</td>
<td class="comment-11" rowspan="2">BIT 6,HL[1]  // odd. this tests the bit we've just cleared as if we're setting flags for return. but we can't be as we're followed by another instruction.. unless DEC HL doesn't alter the Z flag .. which is true, it doesn't.</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="47380"></a>B914</td>
<td class="instruction">DEC HL</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="47381"></a>B915</td>
<td class="instruction">RET</td>
<td class="comment-11" rowspan="1">return; %&gt;</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev"><span class="prev-1">Prev: <a class="link" href="47206.html">B866</a></span></td>
<td class="up">Up: <a class="link" href="../maps/all.html#47260">Map</a></td>
<td class="next"><span class="next-1">Next: <a class="link" href="47382.html">B916</a></span></td>
</tr>
</table>
<div class="footer">
<div class="release">The incomplete The Great Escape disassembly 20150123</div>
<div class="copyright">&copy; Denton Designs. Ocean. David Thomas.</div>
<div class="created">Created using <a class="link" href="http://skoolkit.ca/">SkoolKit</a> 4.1.1.</div>
</div>
</body>
</html>