<?xml version="1.0" encoding="utf-8" ?>
<!DOCTYPE html
    PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<title>The Great Escape: Routine at E420</title>
<meta http-equiv="content-type" content="text/html; charset=utf-8" />
<link rel="stylesheet" type="text/css" href="../skoolkit.css" />
<link rel="stylesheet" type="text/css" href="../TheGreatEscape.css" />

</head>
<body class="Asm-c">
<table class="header">
<tr>
<td class="logo"><a class="link" href="../index.html"><img alt="logo" src="../images/logo.png" /></a></td>
<td class="page-header">Routines</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev"><span class="prev-1">Prev: <a class="link" href="E40F.html">E40F</a></span></td>
<td class="up">Up: <a class="link" href="../maps/all.html#e420">Map</a></td>
<td class="next"><span class="next-1">Next: <a class="link" href="E542.html">E542</a></span></td>
</tr>
</table>
<div class="description">E420: Set up vischar plotting.</div>
<table class="disassembly">
<tr>
<td class="routine-comment" colspan="4">
<div class="details">
<div class="paragraph">
Used by the routine at <a class="link" href="B866.html">B866</a>.
</div>
</div>
<table class="input-1">
<tr class="asm-input-header">
<th colspan="2">Input</th>
</tr>
<tr>
<td class="register">HL</td>
<td class="register-desc">Pointer to ? // observed: always the same as IY</td>
</tr>
<tr>
<td class="register">IY</td>
<td class="register-desc">Pointer to visible character.</td>
</tr>
</table>
<table class="output-0">
<tr class="asm-output-header">
<th colspan="2">Output</th>
</tr>

</table>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="e420"></a>E420</td>
<td class="instruction">LD A,$0F</td>
<td class="comment-11" rowspan="3">HL += 15;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="e422"></a>E422</td>
<td class="instruction">ADD A,L</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="e423"></a>E423</td>
<td class="instruction">LD L,A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="e424"></a>E424</td>
<td class="instruction">LD DE,$81B2</td>
<td class="comment-11" rowspan="1">DE = &amp;tinypos_stash_x;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="e427"></a>E427</td>
<td class="instruction">LD A,($68A0)</td>
<td class="comment-11" rowspan="3">if (room_index) &lt;%</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="e42a"></a>E42A</td>
<td class="instruction">AND A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="e42b"></a>E42B</td>
<td class="instruction">JR Z,$E438</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<a name="e42d"></a>
<div class="comments">
<div class="paragraph">
Indoors.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="e42d"></a>E42D</td>
<td class="instruction">LDI</td>
<td class="comment-11" rowspan="1">*DE++ = *HL++;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="e42f"></a>E42F</td>
<td class="instruction">INC L</td>
<td class="comment-11" rowspan="1">HL++;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="e430"></a>E430</td>
<td class="instruction">LDI</td>
<td class="comment-11" rowspan="1">*DE++ = *HL++;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="e432"></a>E432</td>
<td class="instruction">INC L</td>
<td class="comment-11" rowspan="1">HL++;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="e433"></a>E433</td>
<td class="instruction">LDI</td>
<td class="comment-11" rowspan="1">*DE++ = *HL++;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="e435"></a>E435</td>
<td class="instruction">INC L</td>
<td class="comment-11" rowspan="1">HL++; %&gt;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="e436"></a>E436</td>
<td class="instruction">JR $E44E</td>
<td class="comment-11" rowspan="1">else &lt;%</td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<a name="e438"></a>
<div class="comments">
<div class="paragraph">
Outdoors.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="e438"></a>E438</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-11" rowspan="2">A = *HL++;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="e439"></a>E439</td>
<td class="instruction">INC L</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="e43a"></a>E43A</td>
<td class="instruction">LD C,(HL)</td>
<td class="comment-11" rowspan="1">C = *HL;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="e43b"></a>E43B</td>
<td class="instruction">CALL <a class="link" href="E550.html">$E550</a></td>
<td class="comment-11" rowspan="1">divide_by_8_with_rounding(C,A);</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="e43e"></a>E43E</td>
<td class="instruction">LD (DE),A</td>
<td class="comment-11" rowspan="1">*DE++ = A;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="e43f"></a>E43F</td>
<td class="instruction">INC L</td>
<td class="comment-11" rowspan="2">HL++;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="e440"></a>E440</td>
<td class="instruction">INC DE</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="e441"></a>E441</td>
<td class="instruction">LD B,$02</td>
<td class="comment-11" rowspan="1">B = 2; // 2 iterations</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="e443"></a>E443</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-11" rowspan="2">do &lt;% A = *HL++;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="e444"></a>E444</td>
<td class="instruction">INC L</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="e445"></a>E445</td>
<td class="instruction">LD C,(HL)</td>
<td class="comment-11" rowspan="1">C = *HL;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="e446"></a>E446</td>
<td class="instruction">CALL <a class="link" href="E555.html">$E555</a></td>
<td class="comment-11" rowspan="1">divide_by_8(C,A);</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="e449"></a>E449</td>
<td class="instruction">LD (DE),A</td>
<td class="comment-11" rowspan="1">*DE++ = A;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="e44a"></a>E44A</td>
<td class="instruction">INC L</td>
<td class="comment-11" rowspan="2">HL++;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="e44b"></a>E44B</td>
<td class="instruction">INC DE</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="e44c"></a>E44C</td>
<td class="instruction">DJNZ $E443</td>
<td class="comment-11" rowspan="1">%&gt; while (--B); %&gt;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="e44e"></a>E44E</td>
<td class="instruction">LD C,(HL)</td>
<td class="comment-11" rowspan="2">C = *HL++;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="e44f"></a>E44F</td>
<td class="instruction">INC L</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="e450"></a>E450</td>
<td class="instruction">LD B,(HL)</td>
<td class="comment-11" rowspan="1">B = *HL++;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="e451"></a>E451</td>
<td class="instruction">PUSH BC</td>
<td class="comment-11" rowspan="2">PUSH BC</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="e452"></a>E452</td>
<td class="instruction">INC L</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="e453"></a>E453</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-11" rowspan="2">flip_sprite = *HL++; // set left/right flip flag / sprite offset</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="e454"></a>E454</td>
<td class="instruction">LD ($81B7),A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="e457"></a>E457</td>
<td class="instruction">EX AF,AF'</td>
<td class="comment-11" rowspan="2">-</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="e458"></a>E458</td>
<td class="instruction">INC L</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="e459"></a>E459</td>
<td class="instruction">LD B,$02</td>
<td class="comment-11" rowspan="1">B = 2; // 2 iterations</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="e45b"></a>E45B</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-11" rowspan="2">do &lt;% Adash = *HL++;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="e45c"></a>E45C</td>
<td class="instruction">INC L</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="e45d"></a>E45D</td>
<td class="instruction">LD C,(HL)</td>
<td class="comment-11" rowspan="1">C = *HL++;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="e45e"></a>E45E</td>
<td class="instruction">CALL <a class="link" href="E555.html">$E555</a></td>
<td class="comment-11" rowspan="1">divide_by_8(C,Adash);</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="e461"></a>E461</td>
<td class="instruction">LD (DE),A</td>
<td class="comment-11" rowspan="3">*DE++ = Adash;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="e462"></a>E462</td>
<td class="instruction">INC L</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="e463"></a>E463</td>
<td class="instruction">INC DE</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="e464"></a>E464</td>
<td class="instruction">DJNZ $E45B</td>
<td class="comment-11" rowspan="1">%&gt; while (--B);</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="e466"></a>E466</td>
<td class="instruction">EX AF,AF'</td>
<td class="comment-11" rowspan="1">-</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="e467"></a>E467</td>
<td class="instruction">POP DE</td>
<td class="comment-11" rowspan="1">POP DE</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="e468"></a>E468</td>
<td class="instruction">ADD A,A</td>
<td class="comment-11" rowspan="8">DE += A * 6;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="e469"></a>E469</td>
<td class="instruction">LD C,A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="e46a"></a>E46A</td>
<td class="instruction">ADD A,A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="e46b"></a>E46B</td>
<td class="instruction">ADD A,C</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="e46c"></a>E46C</td>
<td class="instruction">ADD A,E</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="e46d"></a>E46D</td>
<td class="instruction">LD E,A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="e46e"></a>E46E</td>
<td class="instruction">JR NC,$E471</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="e470"></a>E470</td>
<td class="instruction">INC D</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="e471"></a>E471</td>
<td class="instruction">INC L</td>
<td class="comment-11" rowspan="2">L += 2;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="e472"></a>E472</td>
<td class="instruction">INC L</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="e473"></a>E473</td>
<td class="instruction">EX DE,HL</td>
<td class="comment-11" rowspan="1">EX DE,HL</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="e474"></a>E474</td>
<td class="instruction">LDI</td>
<td class="comment-11" rowspan="1">*DE++ = *HL++; // width in bytes</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="e476"></a>E476</td>
<td class="instruction">LDI</td>
<td class="comment-11" rowspan="1">*DE++ = *HL++; // height in rows</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="e478"></a>E478</td>
<td class="instruction">LD DE,$81AC</td>
<td class="comment-11" rowspan="3">memcpy(bitmap_pointer, HL, 4); // copy bitmap pointer and mask pointer</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="e47b"></a>E47B</td>
<td class="instruction">LD BC,$0004</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="e47e"></a>E47E</td>
<td class="instruction">LDIR</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="e480"></a>E480</td>
<td class="instruction">CALL <a class="link" href="BAF7.html">$BAF7</a></td>
<td class="comment-11" rowspan="1">vischar_visible();</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="e483"></a>E483</td>
<td class="instruction">AND A</td>
<td class="comment-11" rowspan="2">if (A) return; /* invisible */</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="e484"></a>E484</td>
<td class="instruction">RET NZ</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="e485"></a>E485</td>
<td class="instruction">PUSH BC</td>
<td class="comment-11" rowspan="1">PUSH BC</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="e486"></a>E486</td>
<td class="instruction">PUSH DE</td>
<td class="comment-11" rowspan="1">PUSH DE</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="e487"></a>E487</td>
<td class="instruction">LD A,(IY+$1E)</td>
<td class="comment-11" rowspan="1">A = IY[30];</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="e48a"></a>E48A</td>
<td class="instruction">CP $03</td>
<td class="comment-11" rowspan="2">if (A == 3) &lt;% // 3 =&gt; 16 wide (4 =&gt; 24 wide)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="e48c"></a>E48C</td>
<td class="instruction">JR NZ,$E49C</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="e48e"></a>E48E</td>
<td class="instruction">LD A,E</td>
<td class="comment-11" rowspan="2">($E2C1 + 1) = E; // self modify masked_sprite_plotter_16_wide_left</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="e48f"></a>E48F</td>
<td class="instruction">LD ($E2C2),A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="e492"></a>E492</td>
<td class="instruction">LD ($E363),A</td>
<td class="comment-11" rowspan="1">($E362 + 1) = E; // self-modify masked_sprite_plotter_16_wide_right</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="e495"></a>E495</td>
<td class="instruction">LD A,$03</td>
<td class="comment-11" rowspan="1">A = 3;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="e497"></a>E497</td>
<td class="instruction">LD HL,$E0E0</td>
<td class="comment-11" rowspan="1">HL = masked_sprite_plotter_16_enables; %&gt;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="e49a"></a>E49A</td>
<td class="instruction">JR $E4A8</td>
<td class="comment-11" rowspan="1">else &lt;%</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="e49c"></a>E49C</td>
<td class="instruction">LD A,E</td>
<td class="comment-11" rowspan="1">-</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="e49d"></a>E49D</td>
<td class="instruction">LD ($E121),A</td>
<td class="comment-11" rowspan="1">($E120 + 1) = E; // self-modify masked_sprite_plotter_24_wide (shift right case)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="e4a0"></a>E4A0</td>
<td class="instruction">LD ($E1E2),A</td>
<td class="comment-11" rowspan="1">($E1E1 + 1) = E; // self-modify masked_sprite_plotter_24_wide (shift left case)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="e4a3"></a>E4A3</td>
<td class="instruction">LD A,$04</td>
<td class="comment-11" rowspan="1">A = 4;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="e4a5"></a>E4A5</td>
<td class="instruction">LD HL,$E0EC</td>
<td class="comment-11" rowspan="1">HL = masked_sprite_plotter_24_enables; %&gt;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="e4a8"></a>E4A8</td>
<td class="instruction">PUSH HL</td>
<td class="comment-11" rowspan="1">PUSH HL</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="e4a9"></a>E4A9</td>
<td class="instruction">LD ($E4C0),A</td>
<td class="comment-11" rowspan="1">($E4BF + 1) = A; // self-modify</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="e4ac"></a>E4AC</td>
<td class="instruction">LD E,A</td>
<td class="comment-11" rowspan="1">E = A;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="e4ad"></a>E4AD</td>
<td class="instruction">LD A,B</td>
<td class="comment-11" rowspan="1">A = B;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="e4ae"></a>E4AE</td>
<td class="instruction">AND A</td>
<td class="comment-11" rowspan="2">if (A == 0) &lt;%</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="e4af"></a>E4AF</td>
<td class="instruction">JR NZ,$E4B7</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="e4b1"></a>E4B1</td>
<td class="instruction">LD A,$77</td>
<td class="comment-11" rowspan="1">A = 0x77; /* opcode of 'LD (HL),A' */</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="e4b3"></a>E4B3</td>
<td class="instruction">EX AF,AF'</td>
<td class="comment-11" rowspan="1">-</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="e4b4"></a>E4B4</td>
<td class="instruction">LD A,C</td>
<td class="comment-11" rowspan="1">Adash = C; %&gt;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="e4b5"></a>E4B5</td>
<td class="instruction">JR $E4BB</td>
<td class="comment-11" rowspan="1">else &lt;%</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="e4b7"></a>E4B7</td>
<td class="instruction">XOR A</td>
<td class="comment-11" rowspan="1">A = 0; /* opcode of 'LD (HL),A' */</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="e4b8"></a>E4B8</td>
<td class="instruction">EX AF,AF'</td>
<td class="comment-11" rowspan="1">-</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="e4b9"></a>E4B9</td>
<td class="instruction">LD A,E</td>
<td class="comment-11" rowspan="2">Adash = E - C; %&gt;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="e4ba"></a>E4BA</td>
<td class="instruction">SUB C</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="e4bb"></a>E4BB</td>
<td class="instruction">EXX</td>
<td class="comment-11" rowspan="1">-</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="e4bc"></a>E4BC</td>
<td class="instruction">POP HL</td>
<td class="comment-11" rowspan="1">POP HLdash</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="e4bd"></a>E4BD</td>
<td class="instruction">LD C,A</td>
<td class="comment-11" rowspan="1">Cdash = Adash;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="e4be"></a>E4BE</td>
<td class="instruction">EX AF,AF'</td>
<td class="comment-11" rowspan="1">-</td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<a name="e4bf"></a>
<div class="comments">
<div class="paragraph">
Set the addresses in the jump table to NOP or LD (HL),A.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="e4bf"></a>E4BF</td>
<td class="instruction">LD B,$03</td>
<td class="comment-11" rowspan="1">Bdash = 3; // 3 iterations // self modified by $E4A9</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="e4c1"></a>E4C1</td>
<td class="instruction">LD E,(HL)</td>
<td class="comment-11" rowspan="2">do &lt;% Edash = *HLdash++;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="e4c2"></a>E4C2</td>
<td class="instruction">INC HL</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="e4c3"></a>E4C3</td>
<td class="instruction">LD D,(HL)</td>
<td class="comment-11" rowspan="1">Ddash = *HLdash++;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="e4c4"></a>E4C4</td>
<td class="instruction">LD (DE),A</td>
<td class="comment-11" rowspan="2">*DEdash = A;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="e4c5"></a>E4C5</td>
<td class="instruction">INC HL</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="e4c6"></a>E4C6</td>
<td class="instruction">LD E,(HL)</td>
<td class="comment-11" rowspan="2">Edash = *HLdash++;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="e4c7"></a>E4C7</td>
<td class="instruction">INC HL</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="e4c8"></a>E4C8</td>
<td class="instruction">LD D,(HL)</td>
<td class="comment-11" rowspan="2">Ddash = *HLdash++;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="e4c9"></a>E4C9</td>
<td class="instruction">INC HL</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="e4ca"></a>E4CA</td>
<td class="instruction">LD (DE),A</td>
<td class="comment-11" rowspan="1">*DEdash = A;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="e4cb"></a>E4CB</td>
<td class="instruction">DEC C</td>
<td class="comment-11" rowspan="1">Cdash--;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="e4cc"></a>E4CC</td>
<td class="instruction">JR NZ,$E4D0</td>
<td class="comment-11" rowspan="2">if (Z) A ^= 0x77; /* Toggle between LD and NOP. */</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="e4ce"></a>E4CE</td>
<td class="instruction">XOR $77</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="e4d0"></a>E4D0</td>
<td class="instruction">DJNZ $E4C1</td>
<td class="comment-11" rowspan="1">%&gt; while (--Bdash);</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="e4d2"></a>E4D2</td>
<td class="instruction">EXX</td>
<td class="comment-11" rowspan="1">-</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="e4d3"></a>E4D3</td>
<td class="instruction">LD A,D</td>
<td class="comment-11" rowspan="1">A = D;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="e4d4"></a>E4D4</td>
<td class="instruction">AND A</td>
<td class="comment-11" rowspan="1">A &amp;= A;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="e4d5"></a>E4D5</td>
<td class="instruction">LD DE,$0000</td>
<td class="comment-11" rowspan="1">DE = 0;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="e4d8"></a>E4D8</td>
<td class="instruction">JR NZ,$E4F5</td>
<td class="comment-11" rowspan="1">if (Z) &lt;%</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="e4da"></a>E4DA</td>
<td class="instruction">LD A,($81BC)</td>
<td class="comment-11" rowspan="6">HL = $81BC * 8; // &amp;map_position + 1;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="e4dd"></a>E4DD</td>
<td class="instruction">LD L,A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="e4de"></a>E4DE</td>
<td class="instruction">LD H,$00</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="e4e0"></a>E4E0</td>
<td class="instruction">ADD HL,HL</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="e4e1"></a>E4E1</td>
<td class="instruction">ADD HL,HL</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="e4e2"></a>E4E2</td>
<td class="instruction">ADD HL,HL</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="e4e3"></a>E4E3</td>
<td class="instruction">EX DE,HL</td>
<td class="comment-11" rowspan="1">EX DE,HL</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="e4e4"></a>E4E4</td>
<td class="instruction">LD L,(IY+$1A)</td>
<td class="comment-11" rowspan="1">L = IY[26];</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="e4e7"></a>E4E7</td>
<td class="instruction">LD H,(IY+$1B)</td>
<td class="comment-11" rowspan="1">H = IY[27];</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="e4ea"></a>E4EA</td>
<td class="instruction">AND A</td>
<td class="comment-11" rowspan="1">A &amp;= A;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="e4eb"></a>E4EB</td>
<td class="instruction">SBC HL,DE</td>
<td class="comment-11" rowspan="1">SBC HL,DE</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="e4ed"></a>E4ED</td>
<td class="instruction">ADD HL,HL</td>
<td class="comment-11" rowspan="7">HL *= 24;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="e4ee"></a>E4EE</td>
<td class="instruction">ADD HL,HL</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="e4ef"></a>E4EF</td>
<td class="instruction">ADD HL,HL</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="e4f0"></a>E4F0</td>
<td class="instruction">LD E,L</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="e4f1"></a>E4F1</td>
<td class="instruction">LD D,H</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="e4f2"></a>E4F2</td>
<td class="instruction">ADD HL,HL</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="e4f3"></a>E4F3</td>
<td class="instruction">ADD HL,DE</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="e4f4"></a>E4F4</td>
<td class="instruction">EX DE,HL</td>
<td class="comment-11" rowspan="1">EX DE,HL %&gt;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="e4f5"></a>E4F5</td>
<td class="instruction">LD A,($81B5)</td>
<td class="comment-11" rowspan="5">HL = map_position_related_x - (map_position &amp; 0xFF); // ie. low byte of map_position // signed subtract + extend to 16-bit</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="e4f8"></a>E4F8</td>
<td class="instruction">LD HL,$81BB</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="e4fb"></a>E4FB</td>
<td class="instruction">SUB (HL)</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="e4fc"></a>E4FC</td>
<td class="instruction">LD L,A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="e4fd"></a>E4FD</td>
<td class="instruction">LD H,$00</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="e4ff"></a>E4FF</td>
<td class="instruction">JR NC,$E503</td>
<td class="comment-11" rowspan="2">if (HL &lt; 0) H = 0xFF;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="e501"></a>E501</td>
<td class="instruction">LD H,$FF</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="e503"></a>E503</td>
<td class="instruction">ADD HL,DE</td>
<td class="comment-11" rowspan="3">HL += DE + 0xF290; // screen buffer start address</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="e504"></a>E504</td>
<td class="instruction">LD DE,$F290</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="e507"></a>E507</td>
<td class="instruction">ADD HL,DE</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="e508"></a>E508</td>
<td class="instruction">LD ($81A2),HL</td>
<td class="comment-11" rowspan="1">($81A2) = HL;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="e50b"></a>E50B</td>
<td class="instruction">LD HL,$8100</td>
<td class="comment-11" rowspan="1">HL = 0x8100;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="e50e"></a>E50E</td>
<td class="instruction">POP DE</td>
<td class="comment-11" rowspan="1">POP DE</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="e50f"></a>E50F</td>
<td class="instruction">PUSH DE</td>
<td class="comment-11" rowspan="1">PUSH DE</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="e510"></a>E510</td>
<td class="instruction">LD A,D</td>
<td class="comment-11" rowspan="11">L += D * 4 + (IY[26] &amp; 7) * 4;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="e511"></a>E511</td>
<td class="instruction">ADD A,A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="e512"></a>E512</td>
<td class="instruction">ADD A,A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="e513"></a>E513</td>
<td class="instruction">ADD A,L</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="e514"></a>E514</td>
<td class="instruction">LD L,A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="e515"></a>E515</td>
<td class="instruction">LD A,(IY+$1A)</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="e518"></a>E518</td>
<td class="instruction">AND $07</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="e51a"></a>E51A</td>
<td class="instruction">ADD A,A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="e51b"></a>E51B</td>
<td class="instruction">ADD A,A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="e51c"></a>E51C</td>
<td class="instruction">ADD A,L</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="e51d"></a>E51D</td>
<td class="instruction">LD L,A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="e51e"></a>E51E</td>
<td class="instruction">LD ($81B0),HL</td>
<td class="comment-11" rowspan="1">foreground_mask_pointer = HL;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="e521"></a>E521</td>
<td class="instruction">POP DE</td>
<td class="comment-11" rowspan="1">POP DE</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="e522"></a>E522</td>
<td class="instruction">LD A,D</td>
<td class="comment-11" rowspan="1">A = D;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="e523"></a>E523</td>
<td class="instruction">AND A</td>
<td class="comment-11" rowspan="2">if (A) &lt;%</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="e524"></a>E524</td>
<td class="instruction">JR Z,$E531</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<a name="e526"></a>
<div class="comments">
<div class="paragraph">
Generic multiply loop.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="e526"></a>E526</td>
<td class="instruction">LD D,A</td>
<td class="comment-11" rowspan="1">D = A;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="e527"></a>E527</td>
<td class="instruction">XOR A</td>
<td class="comment-11" rowspan="1">A = 0;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="e528"></a>E528</td>
<td class="instruction">LD E,(IY+$1E)</td>
<td class="comment-11" rowspan="2">E = IY[30] - 1;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="e52b"></a>E52B</td>
<td class="instruction">DEC E</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<a name="e52c"></a>
<div class="comments">
<div class="paragraph">
D ends up as zero either way.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="e52c"></a>E52C</td>
<td class="instruction">ADD A,E</td>
<td class="comment-11" rowspan="3">do &lt;% A += E; %&gt; while (--D); %&gt;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="e52d"></a>E52D</td>
<td class="instruction">DEC D</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="e52e"></a>E52E</td>
<td class="instruction">JP NZ,$E52C</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="e531"></a>E531</td>
<td class="instruction">LD E,A</td>
<td class="comment-11" rowspan="1">E = A;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="e532"></a>E532</td>
<td class="instruction">LD HL,($81AC)</td>
<td class="comment-11" rowspan="3">bitmap_pointer += DE;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="e535"></a>E535</td>
<td class="instruction">ADD HL,DE</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="e536"></a>E536</td>
<td class="instruction">LD ($81AC),HL</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="e539"></a>E539</td>
<td class="instruction">LD HL,($81AE)</td>
<td class="comment-11" rowspan="3">mask_pointer += DE;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="e53c"></a>E53C</td>
<td class="instruction">ADD HL,DE</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="e53d"></a>E53D</td>
<td class="instruction">LD ($81AE),HL</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="e540"></a>E540</td>
<td class="instruction">POP BC</td>
<td class="comment-11" rowspan="1">POP BC</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="e541"></a>E541</td>
<td class="instruction">RET</td>
<td class="comment-11" rowspan="1">return; /* visible */</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev"><span class="prev-1">Prev: <a class="link" href="E40F.html">E40F</a></span></td>
<td class="up">Up: <a class="link" href="../maps/all.html#e420">Map</a></td>
<td class="next"><span class="next-1">Next: <a class="link" href="E542.html">E542</a></span></td>
</tr>
</table>
<div class="footer">
<div class="release">The incomplete The Great Escape disassembly 20150622</div>
<div class="copyright">&copy; Denton Designs. Ocean. David Thomas.</div>
<div class="created">Created using <a class="link" href="http://skoolkit.ca/">SkoolKit</a> 4.4.</div>
</div>
</body>
</html>