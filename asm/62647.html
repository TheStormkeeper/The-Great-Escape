<?xml version="1.0" encoding="utf-8" ?>
<!DOCTYPE html
    PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<title>The Great Escape: Routine at F4B7</title>
<meta http-equiv="content-type" content="text/html; charset=utf-8" />
<link rel="stylesheet" type="text/css" href="../TheGreatEscape.css" />

</head>
<body class="Asm-c">
<table class="header">
<tr>
<td class="logo"><a class="link" href="../index.html"><img alt="logo" src="../images/logo.png" /></a></td>
<td class="page-header">Routines</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev"><span class="prev-1">Prev: <a class="link" href="62534.html">F446</a></span></td>
<td class="up">Up: <a class="link" href="../maps/all.html#62647">Map</a></td>
<td class="next"><span class="next-1">Next: <a class="link" href="62764.html">F52C</a></span></td>
</tr>
</table>
<div class="description">F4B7: menu_screen</div>
<table class="disassembly">
<tr>
<td class="routine-comment" colspan="4">
<div class="details">
<div class="paragraph">
Runs the menu screen: waiting for user to select an input device, waving the morale flag and playing the title tune.
</div>
</div>
<table class="input-0">
<tr class="asm-input-header">
<th colspan="2">Input</th>
</tr>

</table>
<table class="output-0">
<tr class="asm-output-header">
<th colspan="2">Output</th>
</tr>

</table>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="62647"></a>F4B7</td>
<td class="instruction">CALL <a class="link" href="62065.html">$F271</a></td>
<td class="comment-11" rowspan="1">for (;;) { select_input_device();</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="62650"></a>F4BA</td>
<td class="instruction">CALL <a class="link" href="41013.html">$A035</a></td>
<td class="comment-11" rowspan="1">wave_morale_flag();</td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<a name="62653"></a>
<div class="comments">
<div class="paragraph">
Play music.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="62653"></a>F4BD</td>
<td class="instruction">LD HL,($F541)</td>
<td class="comment-11" rowspan="2">HL = music_channel0_index + 1;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="62656"></a>F4C0</td>
<td class="instruction">INC HL</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="62657"></a>F4C1</td>
<td class="instruction">LD ($F541),HL</td>
<td class="comment-11" rowspan="1">for (;;) { music_channel0_index = HL;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="62660"></a>F4C4</td>
<td class="instruction">LD DE,$F546</td>
<td class="comment-11" rowspan="3">A = music_channel0_data[HL];</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="62663"></a>F4C7</td>
<td class="instruction">ADD HL,DE</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="62664"></a>F4C8</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="62665"></a>F4C9</td>
<td class="instruction">CP $FF</td>
<td class="comment-11" rowspan="2">if (A != 0xFF) break; // end marker</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="62667"></a>F4CB</td>
<td class="instruction">JR NZ,$F4D2</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="62669"></a>F4CD</td>
<td class="instruction">LD HL,$0000</td>
<td class="comment-11" rowspan="1">HL = 0;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="62672"></a>F4D0</td>
<td class="instruction">JR $F4C1</td>
<td class="comment-11" rowspan="1">}</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="62674"></a>F4D2</td>
<td class="instruction">CALL <a class="link" href="62764.html">$F52C</a></td>
<td class="comment-11" rowspan="1">get_tuning();</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="62677"></a>F4D5</td>
<td class="instruction">EXX</td>
<td class="comment-11" rowspan="1">-</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="62678"></a>F4D6</td>
<td class="instruction">LD HL,($F543)</td>
<td class="comment-11" rowspan="2">HLdash = music_channel1_index + 1;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="62681"></a>F4D9</td>
<td class="instruction">INC HL</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="62682"></a>F4DA</td>
<td class="instruction">LD ($F543),HL</td>
<td class="comment-11" rowspan="1">for (;;) { music_channel1_index = HLdash;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="62685"></a>F4DD</td>
<td class="instruction">LD DE,$F7C7</td>
<td class="comment-11" rowspan="3">A = music_channel1_data[HLdash];</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="62688"></a>F4E0</td>
<td class="instruction">ADD HL,DE</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="62689"></a>F4E1</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="62690"></a>F4E2</td>
<td class="instruction">CP $FF</td>
<td class="comment-11" rowspan="2">if (A != 0xFF) break; // end marker</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="62692"></a>F4E4</td>
<td class="instruction">JR NZ,$F4EB</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="62694"></a>F4E6</td>
<td class="instruction">LD HL,$0000</td>
<td class="comment-11" rowspan="1">HLdash = 0;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="62697"></a>F4E9</td>
<td class="instruction">JR $F4DA</td>
<td class="comment-11" rowspan="1">}</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="62699"></a>F4EB</td>
<td class="instruction">CALL <a class="link" href="62764.html">$F52C</a></td>
<td class="comment-11" rowspan="1">get_tuning(); // using banked registers</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="62702"></a>F4EE</td>
<td class="instruction">LD A,B</td>
<td class="comment-11" rowspan="1">A = Bdash;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="62703"></a>F4EF</td>
<td class="instruction">EXX</td>
<td class="comment-11" rowspan="1">-</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="62704"></a>F4F0</td>
<td class="instruction">PUSH BC</td>
<td class="comment-11" rowspan="1">PUSH BC</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="62705"></a>F4F1</td>
<td class="instruction">CP $FF</td>
<td class="comment-11" rowspan="7">if (A == 0xFF) } - POP BCdash {    DEdash = BCdash; } -</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="62707"></a>F4F3</td>
<td class="instruction">JR NZ,$F4FC</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="62709"></a>F4F5</td>
<td class="instruction">EXX</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="62710"></a>F4F6</td>
<td class="instruction">POP BC</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="62711"></a>F4F7</td>
<td class="instruction">LD E,C</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="62712"></a>F4F8</td>
<td class="instruction">LD D,B</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="62713"></a>F4F9</td>
<td class="instruction">EXX</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="62714"></a>F4FA</td>
<td class="instruction">JR $F4FD</td>
<td class="comment-11" rowspan="1">else {</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="62716"></a>F4FC</td>
<td class="instruction">POP BC</td>
<td class="comment-11" rowspan="1">POP BC }</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="62717"></a>F4FD</td>
<td class="instruction">LD A,$18</td>
<td class="comment-11" rowspan="1">A = 24; // overall tune speed (lower =&gt; faster)</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="62719"></a>F4FF</td>
<td class="instruction">EX AF,AF'</td>
<td class="comment-11" rowspan="1">do { -</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="62720"></a>F500</td>
<td class="instruction">LD H,$FF</td>
<td class="comment-11" rowspan="1">H = 0xFF; // iterations</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="62722"></a>F502</td>
<td class="instruction">DJNZ $F510</td>
<td class="comment-11" rowspan="1">do { if (--B == 0) { // big-endian counting down?</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="62724"></a>F504</td>
<td class="instruction">DEC C</td>
<td class="comment-11" rowspan="7">if (--C == 0) } {          L ^= 16; } OUT ($FE),L {          BC = DE; }</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="62725"></a>F505</td>
<td class="instruction">JP NZ,$F510</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="62728"></a>F508</td>
<td class="instruction">LD A,L</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="62729"></a>F509</td>
<td class="instruction">XOR $10</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="62731"></a>F50B</td>
<td class="instruction">LD L,A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="62732"></a>F50C</td>
<td class="instruction">OUT ($FE),A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="62734"></a>F50E</td>
<td class="instruction">LD C,E</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="62735"></a>F50F</td>
<td class="instruction">LD B,D</td>
<td class="comment-11" rowspan="1">}</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="62736"></a>F510</td>
<td class="instruction">EXX</td>
<td class="comment-11" rowspan="1">-</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="62737"></a>F511</td>
<td class="instruction">DJNZ $F51F</td>
<td class="comment-11" rowspan="1">if (--Bdash == 0) {</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="62739"></a>F513</td>
<td class="instruction">DEC C</td>
<td class="comment-11" rowspan="7">if (--Cdash == 0) } {          Ldash ^= 16; } OUT ($FE),Ldash {          BCdash = DEdash; }</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="62740"></a>F514</td>
<td class="instruction">JP NZ,$F51F</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="62743"></a>F517</td>
<td class="instruction">LD A,L</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="62744"></a>F518</td>
<td class="instruction">XOR $10</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="62746"></a>F51A</td>
<td class="instruction">LD L,A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="62747"></a>F51B</td>
<td class="instruction">OUT ($FE),A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="62749"></a>F51D</td>
<td class="instruction">LD C,E</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="62750"></a>F51E</td>
<td class="instruction">LD B,D</td>
<td class="comment-11" rowspan="1">}</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="62751"></a>F51F</td>
<td class="instruction">EXX</td>
<td class="comment-11" rowspan="1">-</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="62752"></a>F520</td>
<td class="instruction">DEC H</td>
<td class="comment-11" rowspan="1">} while (--H);</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="62753"></a>F521</td>
<td class="instruction">JP NZ,$F502</td>
<td class="comment-11" rowspan="1">}</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="62756"></a>F524</td>
<td class="instruction">EX AF,AF'</td>
<td class="comment-11" rowspan="1">-</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="62757"></a>F525</td>
<td class="instruction">DEC A</td>
<td class="comment-11" rowspan="1">} while (--A);</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="62758"></a>F526</td>
<td class="instruction">JP NZ,$F4FF</td>
<td class="comment-11" rowspan="1">}</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="62761"></a>F529</td>
<td class="instruction">JP $F4B7</td>
<td class="comment-11" rowspan="1">}</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev"><span class="prev-1">Prev: <a class="link" href="62534.html">F446</a></span></td>
<td class="up">Up: <a class="link" href="../maps/all.html#62647">Map</a></td>
<td class="next"><span class="next-1">Next: <a class="link" href="62764.html">F52C</a></span></td>
</tr>
</table>
<div class="footer">
<div class="release">The incomplete The Great Escape disassembly 20140604</div>
<div class="copyright">&copy; Denton Designs. Ocean. David Thomas.</div>
<div class="created">Created using <a class="link" href="http://pyskool.ca/?page_id=177">SkoolKit</a> 4.0.</div>
</div>
</body>
</html>