<?xml version="1.0" encoding="utf-8" ?>
<!DOCTYPE html
    PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="content-type" content="text/html; charset=utf-8" />
<title>The Great Escape: Routine at ADBD</title>
<link rel="stylesheet" type="text/css" href="../TheGreatEscape.css" />
</head>
<body class="disassembly">
<table class="header">
<tr>
<td class="headerLogo"><a class="link" href="../index.html"><img alt="logo" src="../images/logo.png" /></a></td>
<td class="headerText">Routines</td>
</tr>
</table>
<table class="prevNext">
<tr>
<td class="prev">Prev: <a class="link" href="44377.html">AD59</a></td>
<td class="up">Up: <a class="link" href="../maps/all.html#44477">Map</a></td>
<td class="next">Next: <a class="link" href="44661.html">AE75</a></td>
</tr>
</table>
<div class="description">ADBD: nighttime</div>
<table class="disassembly">
<tr>
<td class="routineComment" colspan="3">
<div class="details">
<div class="paragraph">
Turns white screen elements light blue and tracks the player with a searchlight.
</div>
</div>
</td>
</tr>
<tr>
<td class="label"><a name="44477"></a>ADBD</td>
<td class="instruction">LD HL,$81BD</td>
<td class="comment">HL = &amp;searchlight_state;</td>
</tr>
<tr>
<td class="address"><a name="44480"></a>ADC0</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment" rowspan="3">if (*HL == searchlight_STATE_OFF) goto not_tracking;</td>
</tr>
<tr>
<td class="address"><a name="44481"></a>ADC1</td>
<td class="instruction">CP $FF</td>
</tr>
<tr>
<td class="address"><a name="44483"></a>ADC3</td>
<td class="instruction">JP Z,$AE0D</td>
</tr>
<tr>
<td class="address"><a name="44486"></a>ADC6</td>
<td class="instruction">LD A,($68A0)</td>
<td class="comment" rowspan="5">if (room_index) { // player is indoors } *HL = searchlight_STATE_OFF; return;</td>
</tr>
<tr>
<td class="address"><a name="44489"></a>ADC9</td>
<td class="instruction">AND A</td>
</tr>
<tr>
<td class="address"><a name="44490"></a>ADCA</td>
<td class="instruction">JR Z,$ADCF</td>
</tr>
<tr>
<td class="routineComment" colspan="3">
<a name="44492"></a>
<div class="comments">
<div class="paragraph">
If the player goes indoors the searchlight loses track.
</div>
</div>
</td>
</tr>
<tr>
<td class="address">ADCC</td>
<td class="instruction">LD (HL),$FF</td>
</tr>
<tr>
<td class="address"><a name="44494"></a>ADCE</td>
<td class="instruction">RET</td>
</tr>
<tr>
<td class="routineComment" colspan="3">
<a name="44495"></a>
<div class="comments">
<div class="paragraph">
Player is outdoors.
</div>
</div>
</td>
</tr>
<tr>
<td class="label">ADCF</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment" rowspan="30">if (*HL == searchlight_STATE_1F) } HL = map_position; {  E = L + 4; } D = H; HL = searchlight_coords; {  if (L == E) { } {    if (H == D) return; } // highlight doesn't need to move, so quit } else { if (L &lt; E) { L++; } else { L--; } } {  if (H != D) { } if (H &lt; D) { H++; } else { H--; } } searchlight_coords = HL;</td>
</tr>
<tr>
<td class="address"><a name="44496"></a>ADD0</td>
<td class="instruction">CP $1F</td>
</tr>
<tr>
<td class="address"><a name="44498"></a>ADD2</td>
<td class="instruction">JP NZ,$AE00</td>
</tr>
<tr>
<td class="address"><a name="44501"></a>ADD5</td>
<td class="instruction">LD HL,($81BB)</td>
</tr>
<tr>
<td class="address"><a name="44504"></a>ADD8</td>
<td class="instruction">LD A,L</td>
</tr>
<tr>
<td class="address"><a name="44505"></a>ADD9</td>
<td class="instruction">ADD A,$04</td>
</tr>
<tr>
<td class="address"><a name="44507"></a>ADDB</td>
<td class="instruction">LD E,A</td>
</tr>
<tr>
<td class="address"><a name="44508"></a>ADDC</td>
<td class="instruction">LD D,H</td>
</tr>
<tr>
<td class="address"><a name="44509"></a>ADDD</td>
<td class="instruction">LD HL,($AE76)</td>
</tr>
<tr>
<td class="address"><a name="44512"></a>ADE0</td>
<td class="instruction">LD A,L</td>
</tr>
<tr>
<td class="address"><a name="44513"></a>ADE1</td>
<td class="instruction">CP E</td>
</tr>
<tr>
<td class="address"><a name="44514"></a>ADE2</td>
<td class="instruction">JR NZ,$ADE9</td>
</tr>
<tr>
<td class="address"><a name="44516"></a>ADE4</td>
<td class="instruction">LD A,H</td>
</tr>
<tr>
<td class="address"><a name="44517"></a>ADE5</td>
<td class="instruction">CP D</td>
</tr>
<tr>
<td class="address"><a name="44518"></a>ADE6</td>
<td class="instruction">RET Z</td>
</tr>
<tr>
<td class="address"><a name="44519"></a>ADE7</td>
<td class="instruction">JR $ADF1</td>
</tr>
<tr>
<td class="routineComment" colspan="3">
<a name="44521"></a>
<div class="comments">
<div class="paragraph">
Move searchlight left/right to focus on player.
</div>
</div>
</td>
</tr>
<tr>
<td class="label">ADE9</td>
<td class="instruction">JP NC,$ADEF</td>
</tr>
<tr>
<td class="address"><a name="44524"></a>ADEC</td>
<td class="instruction">INC A</td>
</tr>
<tr>
<td class="address"><a name="44525"></a>ADED</td>
<td class="instruction">JR $ADF0</td>
</tr>
<tr>
<td class="label"><a name="44527"></a>ADEF</td>
<td class="instruction">DEC A</td>
</tr>
<tr>
<td class="label"><a name="44528"></a>ADF0</td>
<td class="instruction">LD L,A</td>
</tr>
<tr>
<td class="routineComment" colspan="3">
<a name="44529"></a>
<div class="comments">
<div class="paragraph">
Move searchlight up/down to focus on player.
</div>
</div>
</td>
</tr>
<tr>
<td class="label">ADF1</td>
<td class="instruction">LD A,H</td>
</tr>
<tr>
<td class="address"><a name="44530"></a>ADF2</td>
<td class="instruction">CP D</td>
</tr>
<tr>
<td class="address"><a name="44531"></a>ADF3</td>
<td class="instruction">JR Z,$ADFD</td>
</tr>
<tr>
<td class="address"><a name="44533"></a>ADF5</td>
<td class="instruction">JP NC,$ADFB</td>
</tr>
<tr>
<td class="address"><a name="44536"></a>ADF8</td>
<td class="instruction">INC A</td>
</tr>
<tr>
<td class="address"><a name="44537"></a>ADF9</td>
<td class="instruction">JR $ADFC</td>
</tr>
<tr>
<td class="label"><a name="44539"></a>ADFB</td>
<td class="instruction">DEC A</td>
</tr>
<tr>
<td class="label"><a name="44540"></a>ADFC</td>
<td class="instruction">LD H,A</td>
</tr>
<tr>
<td class="label"><a name="44541"></a>ADFD</td>
<td class="instruction">LD ($AE76),HL</td>
</tr>
<tr>
<td class="label"><a name="44544"></a>AE00</td>
<td class="instruction">LD DE,($81BB)</td>
<td class="comment">DE = map_position;</td>
</tr>
<tr>
<td class="address"><a name="44548"></a>AE04</td>
<td class="instruction">LD HL,$AE77</td>
<td class="comment">HL = $AE77; // &amp;searchlight_coords + 1 byte; // compensating for HL--; jumped into</td>
</tr>
<tr>
<td class="address"><a name="44551"></a>AE07</td>
<td class="instruction">LD B,$01</td>
<td class="comment">B = 1; // 1 iteration</td>
</tr>
<tr>
<td class="address"><a name="44553"></a>AE09</td>
<td class="instruction">PUSH BC</td>
<td class="comment">PUSH BC</td>
</tr>
<tr>
<td class="address"><a name="44554"></a>AE0A</td>
<td class="instruction">PUSH HL</td>
<td class="comment">PUSH HL</td>
</tr>
<tr>
<td class="address"><a name="44555"></a>AE0B</td>
<td class="instruction">JR $AE3F</td>
<td class="comment">goto $AE3F;</td>
</tr>
<tr>
<td class="label"><a name="44557"></a>AE0D</td>
<td class="instruction">LD HL,$AD29</td>
<td class="comment">not_tracking: HL = &amp;spotlight_movement_data_maybe[0];</td>
</tr>
<tr>
<td class="address"><a name="44560"></a>AE10</td>
<td class="instruction">LD B,$03</td>
<td class="comment">B = 3; // 3 iterations</td>
</tr>
<tr>
<td class="label"><a name="44562"></a>AE12</td>
<td class="instruction">PUSH BC</td>
<td class="comment">do { PUSH BC</td>
</tr>
<tr>
<td class="address"><a name="44563"></a>AE13</td>
<td class="instruction">PUSH HL</td>
<td class="comment">PUSH HL</td>
</tr>
<tr>
<td class="address"><a name="44564"></a>AE14</td>
<td class="instruction">CALL <a class="link" href="44377.html">$AD59</a></td>
<td class="comment">searchlight_AD59();</td>
</tr>
<tr>
<td class="address"><a name="44567"></a>AE17</td>
<td class="instruction">POP HL</td>
<td class="comment">POP HL</td>
</tr>
<tr>
<td class="address"><a name="44568"></a>AE18</td>
<td class="instruction">PUSH HL</td>
<td class="comment">PUSH HL</td>
</tr>
<tr>
<td class="address"><a name="44569"></a>AE19</td>
<td class="instruction">CALL <a class="link" href="44664.html">$AE78</a></td>
<td class="comment">searchlight_caught();</td>
</tr>
<tr>
<td class="address"><a name="44572"></a>AE1C</td>
<td class="instruction">POP HL</td>
<td class="comment">POP HL</td>
</tr>
<tr>
<td class="address"><a name="44573"></a>AE1D</td>
<td class="instruction">PUSH HL</td>
<td class="comment">PUSH HL</td>
</tr>
<tr>
<td class="address"><a name="44574"></a>AE1E</td>
<td class="instruction">LD DE,($81BB)</td>
<td class="comment">DE = map_position;</td>
</tr>
<tr>
<td class="address"><a name="44578"></a>AE22</td>
<td class="instruction">LD A,E</td>
<td class="comment" rowspan="4">if (E + 23 &lt; *HL) goto next; // out of bounds maybe</td>
</tr>
<tr>
<td class="address"><a name="44579"></a>AE23</td>
<td class="instruction">ADD A,$17</td>
</tr>
<tr>
<td class="address"><a name="44581"></a>AE25</td>
<td class="instruction">CP (HL)</td>
</tr>
<tr>
<td class="address"><a name="44582"></a>AE26</td>
<td class="instruction">JP C,$AE6C</td>
</tr>
<tr>
<td class="address"><a name="44585"></a>AE29</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment" rowspan="4">if (*HL + 16 &lt; E) goto next;</td>
</tr>
<tr>
<td class="address"><a name="44586"></a>AE2A</td>
<td class="instruction">ADD A,$10</td>
</tr>
<tr>
<td class="address"><a name="44588"></a>AE2C</td>
<td class="instruction">CP E</td>
</tr>
<tr>
<td class="address"><a name="44589"></a>AE2D</td>
<td class="instruction">JP C,$AE6C</td>
</tr>
<tr>
<td class="address"><a name="44592"></a>AE30</td>
<td class="instruction">INC HL</td>
<td class="comment">HL++;</td>
</tr>
<tr>
<td class="address"><a name="44593"></a>AE31</td>
<td class="instruction">LD A,D</td>
<td class="comment" rowspan="4">if (D + 16 &lt; *HL) goto next;</td>
</tr>
<tr>
<td class="address"><a name="44594"></a>AE32</td>
<td class="instruction">ADD A,$10</td>
</tr>
<tr>
<td class="address"><a name="44596"></a>AE34</td>
<td class="instruction">CP (HL)</td>
</tr>
<tr>
<td class="address"><a name="44597"></a>AE35</td>
<td class="instruction">JP C,$AE6C</td>
</tr>
<tr>
<td class="address"><a name="44600"></a>AE38</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment" rowspan="4">if (*HL + 16 &lt; D) goto next;</td>
</tr>
<tr>
<td class="address"><a name="44601"></a>AE39</td>
<td class="instruction">ADD A,$10</td>
</tr>
<tr>
<td class="address"><a name="44603"></a>AE3B</td>
<td class="instruction">CP D</td>
</tr>
<tr>
<td class="address"><a name="44604"></a>AE3C</td>
<td class="instruction">JP C,$AE6C</td>
</tr>
<tr>
<td class="label"><a name="44607"></a>AE3F</td>
<td class="instruction">XOR A</td>
<td class="comment">A = 0;</td>
</tr>
<tr>
<td class="address"><a name="44608"></a>AE40</td>
<td class="instruction">EX AF,AF'</td>
<td class="comment">-</td>
</tr>
<tr>
<td class="address"><a name="44609"></a>AE41</td>
<td class="instruction">DEC HL</td>
<td class="comment">HL--;</td>
</tr>
<tr>
<td class="address"><a name="44610"></a>AE42</td>
<td class="instruction">LD B,$00</td>
<td class="comment">B = 0x00;</td>
</tr>
<tr>
<td class="address"><a name="44612"></a>AE44</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment" rowspan="7">if (*HL - E &lt; 0) } B = 0xFF; - A = ~A; -</td>
</tr>
<tr>
<td class="address"><a name="44613"></a>AE45</td>
<td class="instruction">SUB E</td>
</tr>
<tr>
<td class="address"><a name="44614"></a>AE46</td>
<td class="instruction">JP NC,$AE4E</td>
</tr>
<tr>
<td class="address"><a name="44617"></a>AE49</td>
<td class="instruction">LD B,$FF</td>
</tr>
<tr>
<td class="address"><a name="44619"></a>AE4B</td>
<td class="instruction">EX AF,AF'</td>
</tr>
<tr>
<td class="address"><a name="44620"></a>AE4C</td>
<td class="instruction">CPL</td>
</tr>
<tr>
<td class="address"><a name="44621"></a>AE4D</td>
<td class="instruction">EX AF,AF'</td>
</tr>
<tr>
<td class="label"><a name="44622"></a>AE4E</td>
<td class="instruction">LD C,A</td>
<td class="comment">C = Adash;</td>
</tr>
<tr>
<td class="address"><a name="44623"></a>AE4F</td>
<td class="instruction">INC HL</td>
<td class="comment" rowspan="2">Adash = *++HL;</td>
</tr>
<tr>
<td class="address"><a name="44624"></a>AE50</td>
<td class="instruction">LD A,(HL)</td>
</tr>
<tr>
<td class="address"><a name="44625"></a>AE51</td>
<td class="instruction">LD H,$00</td>
<td class="comment">H = 0x00;</td>
</tr>
<tr>
<td class="address"><a name="44627"></a>AE53</td>
<td class="instruction">SUB D</td>
<td class="comment">Adash -= D;</td>
</tr>
<tr>
<td class="address"><a name="44628"></a>AE54</td>
<td class="instruction">JP NC,$AE59</td>
<td class="comment" rowspan="2">if (Adash &lt; 0) H = 0xFF;</td>
</tr>
<tr>
<td class="address"><a name="44631"></a>AE57</td>
<td class="instruction">LD H,$FF</td>
</tr>
<tr>
<td class="label"><a name="44633"></a>AE59</td>
<td class="instruction">LD L,A</td>
<td class="comment">L = Adash;</td>
</tr>
<tr>
<td class="address"><a name="44634"></a>AE5A</td>
<td class="instruction">ADD HL,HL</td>
<td class="comment" rowspan="5">HL *= 32;</td>
</tr>
<tr>
<td class="address"><a name="44635"></a>AE5B</td>
<td class="instruction">ADD HL,HL</td>
</tr>
<tr>
<td class="address"><a name="44636"></a>AE5C</td>
<td class="instruction">ADD HL,HL</td>
</tr>
<tr>
<td class="address"><a name="44637"></a>AE5D</td>
<td class="instruction">ADD HL,HL</td>
</tr>
<tr>
<td class="address"><a name="44638"></a>AE5E</td>
<td class="instruction">ADD HL,HL</td>
</tr>
<tr>
<td class="address"><a name="44639"></a>AE5F</td>
<td class="instruction">ADD HL,BC</td>
<td class="comment">HL += BC;</td>
</tr>
<tr>
<td class="address"><a name="44640"></a>AE60</td>
<td class="instruction">LD BC,$5846</td>
<td class="comment" rowspan="2">HL += 0x5846; // screen attribute address of top-left game window attribute</td>
</tr>
<tr>
<td class="address"><a name="44643"></a>AE63</td>
<td class="instruction">ADD HL,BC</td>
</tr>
<tr>
<td class="address"><a name="44644"></a>AE64</td>
<td class="instruction">EX DE,HL</td>
<td class="comment">EX DE,HL</td>
</tr>
<tr>
<td class="address"><a name="44645"></a>AE65</td>
<td class="instruction">EX AF,AF'</td>
<td class="comment">-</td>
</tr>
<tr>
<td class="address"><a name="44646"></a>AE66</td>
<td class="instruction">LD ($AE75),A</td>
<td class="comment">searchlight_related = A;</td>
</tr>
<tr>
<td class="address"><a name="44649"></a>AE69</td>
<td class="instruction">CALL <a class="link" href="44728.html">$AEB8</a></td>
<td class="comment">searchlight_plot();</td>
</tr>
<tr>
<td class="label"><a name="44652"></a>AE6C</td>
<td class="instruction">POP HL</td>
<td class="comment">next: POP HL</td>
</tr>
<tr>
<td class="address"><a name="44653"></a>AE6D</td>
<td class="instruction">POP BC</td>
<td class="comment">POP BC</td>
</tr>
<tr>
<td class="address"><a name="44654"></a>AE6E</td>
<td class="instruction">LD DE,$0007</td>
<td class="comment" rowspan="2">HL += 7;</td>
</tr>
<tr>
<td class="address"><a name="44657"></a>AE71</td>
<td class="instruction">ADD HL,DE</td>
</tr>
<tr>
<td class="address"><a name="44658"></a>AE72</td>
<td class="instruction">DJNZ $AE12</td>
<td class="comment">} while (--B);</td>
</tr>
<tr>
<td class="address"><a name="44660"></a>AE74</td>
<td class="instruction">RET</td>
<td class="comment">return;</td>
</tr>
</table>
<table class="prevNext">
<tr>
<td class="prev">Prev: <a class="link" href="44377.html">AD59</a></td>
<td class="up">Up: <a class="link" href="../maps/all.html#44477">Map</a></td>
<td class="next">Next: <a class="link" href="44661.html">AE75</a></td>
</tr>
</table>
<div class="footer">
<div class="release">The incomplete The Great Escape disassembly 20140126</div>
<div class="copyright">&copy; Denton Designs. Ocean. David Thomas.</div>
<div class="created">Created using <a class="link" href="http://pyskool.ca/?page_id=177">SkoolKit</a> 3.6.</div>
</div>
</body>
</html>