<?xml version="1.0" encoding="utf-8" ?>
<!DOCTYPE html
    PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<title>The Great Escape: Routine at B79B</title>
<link rel="stylesheet" type="text/css" href="../TheGreatEscape.css" />
</head>
<body class="disassembly">
<table class="header">
<tr>
<td class="headerLogo"><a class="link" href="../index.html"><img src="../images/logo.png" alt="The Great Escape" /></a></td>
<td class="headerText">Routines</td>
</tr>
</table>
<table class="prevNext">
<tr>
<td class="prev">Prev: <a class="link" href="46938.html">B75A</a></td>
<td class="up">Up: <a class="link" href="../maps/all.html#47003">Map</a></td>
<td class="next">Next: <a class="link" href="47129.html">B819</a></td>
</tr>
</table>
<div class="description">B79B: reset_map_and_characters</div>
<table class="disassembly">
<tr>
<td class="routineComment" colspan="3">
<div class="details">
<div class="paragraph">
Resets all visible characters, dispatch_counter, day_or_night flag, general flags, collapsed tunnel objects, locks the gates, resets all beds, clears the mess halls and resets characters.
</div>
</div>
</td>
</tr>
<tr>
<td class="label"><a name="47003"></a>B79B</td>
<td class="instruction">LD B,$07</td>
<td class="comment">B = 7; // iterations</td>
</tr>
<tr>
<td class="address"><a name="47005"></a>B79D</td>
<td class="instruction">LD HL,$8020</td>
<td class="comment">HL = $8020; // iterate over non-player characters</td>
</tr>
<tr>
<td class="label"><a name="47008"></a>B7A0</td>
<td class="instruction">PUSH BC</td>
<td class="comment" rowspan="9">do } {  reset_visible_character(); } {  HL += 32; } while (--B);</td>
</tr>
<tr>
<td class="address"><a name="47009"></a>B7A1</td>
<td class="instruction">PUSH HL</td>
</tr>
<tr>
<td class="address"><a name="47010"></a>B7A2</td>
<td class="instruction">CALL <a class="link" href="50643.html">$C5D3</a></td>
</tr>
<tr>
<td class="address"><a name="47013"></a>B7A5</td>
<td class="instruction">POP HL</td>
</tr>
<tr>
<td class="address"><a name="47014"></a>B7A6</td>
<td class="instruction">LD A,L</td>
</tr>
<tr>
<td class="address"><a name="47015"></a>B7A7</td>
<td class="instruction">ADD A,$20</td>
</tr>
<tr>
<td class="address"><a name="47017"></a>B7A9</td>
<td class="instruction">LD L,A</td>
</tr>
<tr>
<td class="address"><a name="47018"></a>B7AA</td>
<td class="instruction">POP BC</td>
</tr>
<tr>
<td class="address"><a name="47019"></a>B7AB</td>
<td class="instruction">DJNZ $B7A0</td>
</tr>
<tr>
<td class="address"><a name="47021"></a>B7AD</td>
<td class="instruction">LD A,$07</td>
<td class="comment" rowspan="2">dispatch_counter = 7;</td>
</tr>
<tr>
<td class="address"><a name="47023"></a>B7AF</td>
<td class="instruction">LD ($A13D),A</td>
</tr>
<tr>
<td class="address"><a name="47026"></a>B7B2</td>
<td class="instruction">XOR A</td>
<td class="comment" rowspan="2">day_or_night = 0;</td>
</tr>
<tr>
<td class="address"><a name="47027"></a>B7B3</td>
<td class="instruction">LD ($A146),A</td>
</tr>
<tr>
<td class="address"><a name="47030"></a>B7B6</td>
<td class="instruction">LD ($8001),A</td>
<td class="comment">($8001) = 0; // flags</td>
</tr>
<tr>
<td class="address"><a name="47033"></a>B7B9</td>
<td class="instruction">LD A,$14</td>
<td class="comment" rowspan="2">collapsed_tunnel_obj = interiorobject_COLLAPSED_TUNNEL;</td>
</tr>
<tr>
<td class="address"><a name="47035"></a>B7BB</td>
<td class="instruction">LD ($708C),A</td>
</tr>
<tr>
<td class="address"><a name="47038"></a>B7BE</td>
<td class="instruction">LD A,$34</td>
<td class="comment" rowspan="2">blockage = 0x34;</td>
</tr>
<tr>
<td class="address"><a name="47040"></a>B7C0</td>
<td class="instruction">LD ($7077),A</td>
</tr>
<tr>
<td class="routineComment" colspan="3">
<a name="47043"></a>
<div class="comments">
<div class="paragraph">
Lock the gates.
</div>
</div>
</td>
</tr>
<tr>
<td class="address">B7C3</td>
<td class="instruction">LD HL,$F05D</td>
<td class="comment">HL = &amp;gates_and_doors[0];</td>
</tr>
<tr>
<td class="address"><a name="47046"></a>B7C6</td>
<td class="instruction">LD B,$09</td>
<td class="comment">B = 9; // 9 iterations</td>
</tr>
<tr>
<td class="label"><a name="47048"></a>B7C8</td>
<td class="instruction">SET 7,(HL)</td>
<td class="comment" rowspan="3">do { *HL++ |= gates_and_doors_LOCKED; } while (--B);</td>
</tr>
<tr>
<td class="address"><a name="47050"></a>B7CA</td>
<td class="instruction">INC HL</td>
</tr>
<tr>
<td class="address"><a name="47051"></a>B7CB</td>
<td class="instruction">DJNZ $B7C8</td>
</tr>
<tr>
<td class="routineComment" colspan="3">
<a name="47053"></a>
<div class="comments">
<div class="paragraph">
Reset all beds.
</div>
</div>
</td>
</tr>
<tr>
<td class="address">B7CD</td>
<td class="instruction">LD B,$06</td>
<td class="comment">B = 6; // iterations</td>
</tr>
<tr>
<td class="address"><a name="47055"></a>B7CF</td>
<td class="instruction">LD A,$17</td>
<td class="comment" rowspan="2">HL = &amp;beds[0];</td>
</tr>
<tr>
<td class="address"><a name="47057"></a>B7D1</td>
<td class="instruction">LD HL,$6B79</td>
</tr>
<tr>
<td class="label"><a name="47060"></a>B7D4</td>
<td class="instruction">LD E,(HL)</td>
<td class="comment" rowspan="6">do { E = *HL++; } {  D = *HL++; } *DE = interiorobject_OCCUPIED_BED; while (--B);</td>
</tr>
<tr>
<td class="address"><a name="47061"></a>B7D5</td>
<td class="instruction">INC HL</td>
</tr>
<tr>
<td class="address"><a name="47062"></a>B7D6</td>
<td class="instruction">LD D,(HL)</td>
</tr>
<tr>
<td class="address"><a name="47063"></a>B7D7</td>
<td class="instruction">INC HL</td>
</tr>
<tr>
<td class="address"><a name="47064"></a>B7D8</td>
<td class="instruction">LD (DE),A</td>
</tr>
<tr>
<td class="address"><a name="47065"></a>B7D9</td>
<td class="instruction">DJNZ $B7D4</td>
</tr>
<tr>
<td class="routineComment" colspan="3">
<a name="47067"></a>
<div class="comments">
<div class="paragraph">
Clear the mess halls.
</div>
</div>
</td>
</tr>
<tr>
<td class="address">B7DB</td>
<td class="instruction">LD A,$0D</td>
<td class="comment" rowspan="2">bench_A = interiorobject_EMPTY_BENCH;</td>
</tr>
<tr>
<td class="address"><a name="47069"></a>B7DD</td>
<td class="instruction">LD ($6F17),A</td>
</tr>
<tr>
<td class="address"><a name="47072"></a>B7E0</td>
<td class="instruction">LD ($6F1A),A</td>
<td class="comment">bench_B = interiorobject_EMPTY_BENCH;</td>
</tr>
<tr>
<td class="address"><a name="47075"></a>B7E3</td>
<td class="instruction">LD ($6F1D),A</td>
<td class="comment">bench_C = interiorobject_EMPTY_BENCH;</td>
</tr>
<tr>
<td class="address"><a name="47078"></a>B7E6</td>
<td class="instruction">LD ($6F4F),A</td>
<td class="comment">bench_D = interiorobject_EMPTY_BENCH;</td>
</tr>
<tr>
<td class="address"><a name="47081"></a>B7E9</td>
<td class="instruction">LD ($6F52),A</td>
<td class="comment">bench_E = interiorobject_EMPTY_BENCH;</td>
</tr>
<tr>
<td class="address"><a name="47084"></a>B7EC</td>
<td class="instruction">LD ($6F55),A</td>
<td class="comment">bench_F = interiorobject_EMPTY_BENCH;</td>
</tr>
<tr>
<td class="address"><a name="47087"></a>B7EF</td>
<td class="instruction">LD ($6F58),A</td>
<td class="comment">bench_G = interiorobject_EMPTY_BENCH;</td>
</tr>
<tr>
<td class="routineComment" colspan="3">
<a name="47090"></a>
<div class="comments">
<div class="paragraph">
Reset characters 12..15 and 20..25.
</div>
</div>
</td>
</tr>
<tr>
<td class="address">B7F2</td>
<td class="instruction">LD DE,$7667</td>
<td class="comment">DE = &amp;character_structs[12].BYTE1;</td>
</tr>
<tr>
<td class="address"><a name="47093"></a>B7F5</td>
<td class="instruction">LD C,$0A</td>
<td class="comment">C = 10; // iterations</td>
</tr>
<tr>
<td class="address"><a name="47095"></a>B7F7</td>
<td class="instruction">LD HL,$B819</td>
<td class="comment">HL = &amp;character_reset_data[0];</td>
</tr>
<tr>
<td class="label"><a name="47098"></a>B7FA</td>
<td class="instruction">LD B,$03</td>
<td class="comment">do { B = 3; // iterations</td>
</tr>
<tr>
<td class="label"><a name="47100"></a>B7FC</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment" rowspan="6">do { *DE++ = *HL++; } {  } while (--B);</td>
</tr>
<tr>
<td class="address"><a name="47101"></a>B7FD</td>
<td class="instruction">LD (DE),A</td>
</tr>
<tr>
<td class="address"><a name="47102"></a>B7FE</td>
<td class="instruction">INC DE</td>
</tr>
<tr>
<td class="address"><a name="47103"></a>B7FF</td>
<td class="instruction">INC HL</td>
</tr>
<tr>
<td class="address"><a name="47104"></a>B800</td>
<td class="instruction">DJNZ $B7FC</td>
</tr>
<tr>
<td class="address"><a name="47106"></a>B802</td>
<td class="instruction">EX DE,HL</td>
</tr>
<tr>
<td class="address"><a name="47107"></a>B803</td>
<td class="instruction">LD (HL),$12</td>
<td class="comment" rowspan="2">*DE++ = 0x12; // reset to 0x12 but the initial data is 0x18</td>
</tr>
<tr>
<td class="address"><a name="47109"></a>B805</td>
<td class="instruction">INC HL</td>
</tr>
<tr>
<td class="address"><a name="47110"></a>B806</td>
<td class="instruction">LD (HL),$00</td>
<td class="comment" rowspan="2">*DE++ = 0x00;</td>
</tr>
<tr>
<td class="address"><a name="47112"></a>B808</td>
<td class="instruction">INC HL</td>
</tr>
<tr>
<td class="address"><a name="47113"></a>B809</td>
<td class="instruction">INC HL</td>
<td class="comment" rowspan="3">DE += 2;</td>
</tr>
<tr>
<td class="address"><a name="47114"></a>B80A</td>
<td class="instruction">INC HL</td>
</tr>
<tr>
<td class="address"><a name="47115"></a>B80B</td>
<td class="instruction">EX DE,HL</td>
</tr>
<tr>
<td class="address"><a name="47116"></a>B80C</td>
<td class="instruction">LD A,C</td>
<td class="comment" rowspan="4">if (C == 7) DE = &amp;character_structs[20].BYTE1;</td>
</tr>
<tr>
<td class="address"><a name="47117"></a>B80D</td>
<td class="instruction">CP $07</td>
</tr>
<tr>
<td class="address"><a name="47119"></a>B80F</td>
<td class="instruction">JR NZ,$B814</td>
</tr>
<tr>
<td class="address"><a name="47121"></a>B811</td>
<td class="instruction">LD DE,$769F</td>
</tr>
<tr>
<td class="label"><a name="47124"></a>B814</td>
<td class="instruction">DEC C</td>
<td class="comment">} while (--C);</td>
</tr>
<tr>
<td class="address"><a name="47125"></a>B815</td>
<td class="instruction">JP NZ,$B7FA</td>
<td class="comment">}</td>
</tr>
<tr>
<td class="address"><a name="47128"></a>B818</td>
<td class="instruction">RET</td>
<td class="comment">return;</td>
</tr>
</table>
<table class="prevNext">
<tr>
<td class="prev">Prev: <a class="link" href="46938.html">B75A</a></td>
<td class="up">Up: <a class="link" href="../maps/all.html#47003">Map</a></td>
<td class="next">Next: <a class="link" href="47129.html">B819</a></td>
</tr>
</table>
<div class="footer">
<div class="release">The incomplete The Great Escape disassembly 20130626</div>
<div class="copyright">&copy; Denton Designs. Ocean. David Thomas.</div>
<div class="created">Created using <a class="link" href="http://pyskool.ca/?page_id=177">SkoolKit</a> 3.3.2.</div>
</div>
</body>
</html>