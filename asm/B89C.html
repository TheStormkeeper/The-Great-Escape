<?xml version="1.0" encoding="utf-8" ?>
<!DOCTYPE html
    PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<title>The Great Escape: Routine at B89C</title>
<meta http-equiv="content-type" content="text/html; charset=utf-8" />
<link rel="stylesheet" type="text/css" href="../skoolkit.css" />
<link rel="stylesheet" type="text/css" href="../TheGreatEscape.css" />

</head>
<body class="Asm-c">
<table class="header">
<tr>
<td class="logo"><a class="link" href="../index.html"><img alt="logo" src="../images/logo.png" /></a></td>
<td class="page-header">Routines</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev"><span class="prev-1">Prev: <a class="link" href="B866.html">B866</a></span></td>
<td class="up">Up: <a class="link" href="../maps/all.html#b89c">Map</a></td>
<td class="next"><span class="next-1">Next: <a class="link" href="B916.html">B916</a></span></td>
</tr>
</table>
<div class="description">B89C: Locates a vischar or item to plot.</div>
<table class="disassembly">
<tr>
<td class="routine-comment" colspan="4">
<div class="details">
<div class="paragraph">
Used by the routine at <a class="link" href="B866.html">B866</a>.
</div>
</div>
<table class="input-0">
<tr class="asm-input-header">
<th colspan="2">Input</th>
</tr>

</table>
<table class="output-1">
<tr class="asm-output-header">
<th colspan="2">Output</th>
</tr>
<tr>
<td class="register">IY</td>
<td class="register-desc">vischar or itemstruct to plot.</td>
</tr>
</table>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="b89c"></a>B89C</td>
<td class="instruction">LD BC,$0000</td>
<td class="comment-11" rowspan="1">BC = 0; // prev-x</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="b89f"></a>B89F</td>
<td class="instruction">LD D,C</td>
<td class="comment-11" rowspan="2">DE = 0; // prev-y</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="b8a0"></a>B8A0</td>
<td class="instruction">LD E,C</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="b8a1"></a>B8A1</td>
<td class="instruction">LD A,$FF</td>
<td class="comment-11" rowspan="1">A = 0xFF; // 'nothing found' marker 0xFF</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="b8a3"></a>B8A3</td>
<td class="instruction">EX AF,AF'</td>
<td class="comment-11" rowspan="1">EX AF,AF'</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="b8a4"></a>B8A4</td>
<td class="instruction">EXX</td>
<td class="comment-11" rowspan="1">EXX</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="b8a5"></a>B8A5</td>
<td class="instruction">LD DE,$0000</td>
<td class="comment-11" rowspan="1">DE = 0;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="b8a8"></a>B8A8</td>
<td class="instruction">LD BC,$0820</td>
<td class="comment-11" rowspan="1">B = 8; C = 32; // iterations, stride</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="b8ab"></a>B8AB</td>
<td class="instruction">LD HL,$8007</td>
<td class="comment-11" rowspan="1">HL = $8007; // vischar byte7</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="b8ae"></a>B8AE</td>
<td class="instruction">BIT 7,(HL)</td>
<td class="comment-11" rowspan="2">do &lt;% if ((*HL &amp; vischar_BYTE7_LOCATABLE) == 0) goto next;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="b8b0"></a>B8B0</td>
<td class="instruction">JR Z,$B8F7</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="b8b2"></a>B8B2</td>
<td class="instruction">PUSH HL</td>
<td class="comment-11" rowspan="1">PUSH HL</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="b8b3"></a>B8B3</td>
<td class="instruction">PUSH BC</td>
<td class="comment-11" rowspan="1">PUSH BC</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="b8b4"></a>B8B4</td>
<td class="instruction">LD A,$08</td>
<td class="comment-11" rowspan="3">HL += 8; // $8007 + 8 = $800F = mi.pos.x</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="b8b6"></a>B8B6</td>
<td class="instruction">ADD A,L</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="b8b7"></a>B8B7</td>
<td class="instruction">LD L,A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="b8b8"></a>B8B8</td>
<td class="instruction">LD C,(HL)</td>
<td class="comment-11" rowspan="2">C = *HL++;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="b8b9"></a>B8B9</td>
<td class="instruction">INC L</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="b8ba"></a>B8BA</td>
<td class="instruction">LD B,(HL)</td>
<td class="comment-11" rowspan="1">B = *HL;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="b8bb"></a>B8BB</td>
<td class="instruction">INC BC</td>
<td class="comment-11" rowspan="4">BC += 4;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="b8bc"></a>B8BC</td>
<td class="instruction">INC BC</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="b8bd"></a>B8BD</td>
<td class="instruction">INC BC</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="b8be"></a>B8BE</td>
<td class="instruction">INC BC</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="b8bf"></a>B8BF</td>
<td class="instruction">PUSH BC</td>
<td class="comment-11" rowspan="1">PUSH BC</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="b8c0"></a>B8C0</td>
<td class="instruction">EXX</td>
<td class="comment-11" rowspan="1">EXX</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="b8c1"></a>B8C1</td>
<td class="instruction">POP HL</td>
<td class="comment-11" rowspan="1">POP HL</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="b8c2"></a>B8C2</td>
<td class="instruction">SBC HL,BC</td>
<td class="comment-11" rowspan="1">SBC HL,BC</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="b8c4"></a>B8C4</td>
<td class="instruction">EXX</td>
<td class="comment-11" rowspan="1">EXX</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="b8c5"></a>B8C5</td>
<td class="instruction">JR C,$B8F5</td>
<td class="comment-11" rowspan="1">JR C,pop_next</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="b8c7"></a>B8C7</td>
<td class="instruction">INC L</td>
<td class="comment-11" rowspan="1">HL++;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="b8c8"></a>B8C8</td>
<td class="instruction">LD C,(HL)</td>
<td class="comment-11" rowspan="2">C = *HL++;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="b8c9"></a>B8C9</td>
<td class="instruction">INC L</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="b8ca"></a>B8CA</td>
<td class="instruction">LD B,(HL)</td>
<td class="comment-11" rowspan="1">B = *HL;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="b8cb"></a>B8CB</td>
<td class="instruction">INC BC</td>
<td class="comment-11" rowspan="4">BC += 4;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="b8cc"></a>B8CC</td>
<td class="instruction">INC BC</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="b8cd"></a>B8CD</td>
<td class="instruction">INC BC</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="b8ce"></a>B8CE</td>
<td class="instruction">INC BC</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="b8cf"></a>B8CF</td>
<td class="instruction">PUSH BC</td>
<td class="comment-11" rowspan="1">PUSH BC</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="b8d0"></a>B8D0</td>
<td class="instruction">EXX</td>
<td class="comment-11" rowspan="1">EXX</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="b8d1"></a>B8D1</td>
<td class="instruction">POP HL</td>
<td class="comment-11" rowspan="1">POP HL</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="b8d2"></a>B8D2</td>
<td class="instruction">SBC HL,DE</td>
<td class="comment-11" rowspan="1">SBC HL,DE</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="b8d4"></a>B8D4</td>
<td class="instruction">EXX</td>
<td class="comment-11" rowspan="1">EXX</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="b8d5"></a>B8D5</td>
<td class="instruction">JR C,$B8F5</td>
<td class="comment-11" rowspan="1">JR C,pop_next</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="b8d7"></a>B8D7</td>
<td class="instruction">INC L</td>
<td class="comment-11" rowspan="1">HL++;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="b8d8"></a>B8D8</td>
<td class="instruction">POP BC</td>
<td class="comment-11" rowspan="1">POP BC</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="b8d9"></a>B8D9</td>
<td class="instruction">PUSH BC</td>
<td class="comment-11" rowspan="1">PUSH BC</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="b8da"></a>B8DA</td>
<td class="instruction">LD A,$08</td>
<td class="comment-11" rowspan="2">A = 8 - B; /* Item index. */</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="b8dc"></a>B8DC</td>
<td class="instruction">SUB B</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="b8dd"></a>B8DD</td>
<td class="instruction">EX AF,AF'</td>
<td class="comment-11" rowspan="1">EX AF,AF'  // unpaired</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="b8de"></a>B8DE</td>
<td class="instruction">LD E,(HL)</td>
<td class="comment-11" rowspan="2">E = *HL++;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="b8df"></a>B8DF</td>
<td class="instruction">INC L</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="b8e0"></a>B8E0</td>
<td class="instruction">LD D,(HL)</td>
<td class="comment-11" rowspan="1">D = *HL;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="b8e1"></a>B8E1</td>
<td class="instruction">PUSH HL</td>
<td class="comment-11" rowspan="1">PUSH HL</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="b8e2"></a>B8E2</td>
<td class="instruction">EXX</td>
<td class="comment-11" rowspan="1">EXX</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="b8e3"></a>B8E3</td>
<td class="instruction">POP HL</td>
<td class="comment-11" rowspan="1">POP HL</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="b8e4"></a>B8E4</td>
<td class="instruction">DEC L</td>
<td class="comment-11" rowspan="2">L -= 2;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="b8e5"></a>B8E5</td>
<td class="instruction">DEC L</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="b8e6"></a>B8E6</td>
<td class="instruction">LD D,(HL)</td>
<td class="comment-11" rowspan="2">D = *HL--;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="b8e7"></a>B8E7</td>
<td class="instruction">DEC L</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="b8e8"></a>B8E8</td>
<td class="instruction">LD E,(HL)</td>
<td class="comment-11" rowspan="2">E = *HL--;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="b8e9"></a>B8E9</td>
<td class="instruction">DEC L</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="b8ea"></a>B8EA</td>
<td class="instruction">LD B,(HL)</td>
<td class="comment-11" rowspan="2">B = *HL--;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="b8eb"></a>B8EB</td>
<td class="instruction">DEC L</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="b8ec"></a>B8EC</td>
<td class="instruction">LD C,(HL)</td>
<td class="comment-11" rowspan="1">C = *HL;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="b8ed"></a>B8ED</td>
<td class="instruction">LD A,L</td>
<td class="comment-11" rowspan="3">HL -= 15;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="b8ee"></a>B8EE</td>
<td class="instruction">SUB $0F</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="b8f0"></a>B8F0</td>
<td class="instruction">LD L,A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="b8f1"></a>B8F1</td>
<td class="instruction">PUSH HL</td>
<td class="comment-11" rowspan="2">IY = HL;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="b8f2"></a>B8F2</td>
<td class="instruction">POP IY</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="b8f4"></a>B8F4</td>
<td class="instruction">EXX</td>
<td class="comment-11" rowspan="1">EXX</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="b8f5"></a>B8F5</td>
<td class="instruction">POP BC</td>
<td class="comment-11" rowspan="1">pop_next: POP BC</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="b8f6"></a>B8F6</td>
<td class="instruction">POP HL</td>
<td class="comment-11" rowspan="1">POP HL</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="b8f7"></a>B8F7</td>
<td class="instruction">LD A,L</td>
<td class="comment-11" rowspan="3">next: HL += C;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="b8f8"></a>B8F8</td>
<td class="instruction">ADD A,C</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="b8f9"></a>B8F9</td>
<td class="instruction">LD L,A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="b8fa"></a>B8FA</td>
<td class="instruction">DJNZ $B8AE</td>
<td class="comment-11" rowspan="1">%&gt; while (--B);</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="b8fc"></a>B8FC</td>
<td class="instruction">CALL <a class="link" href="DBEB.html">$DBEB</a></td>
<td class="comment-11" rowspan="1">get_greatest_itemstruct();</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="b8ff"></a>B8FF</td>
<td class="instruction">EX AF,AF'</td>
<td class="comment-11" rowspan="1">EX AF,AF' // extract return value</td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<a name="b900"></a>
<div class="comments">
<div class="paragraph">
If A' top bit remains set from initialisation, then no vischar was found. (It's not affected by get_greatest_itemstruct which passes it through).
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="b900"></a>B900</td>
<td class="instruction">BIT 7,A</td>
<td class="comment-11" rowspan="2">if (A &amp; (1&lt;&lt;7)) return;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="b902"></a>B902</td>
<td class="instruction">RET NZ</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="b903"></a>B903</td>
<td class="instruction">PUSH IY</td>
<td class="comment-11" rowspan="2">HL = IY;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="b905"></a>B905</td>
<td class="instruction">POP HL</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="b906"></a>B906</td>
<td class="instruction">BIT 6,A</td>
<td class="comment-11" rowspan="2">if ((A &amp; (1&lt;&lt;6)) == 0) &lt;% // mysteryflagconst874 'item found' flag?</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="b908"></a>B908</td>
<td class="instruction">JR NZ,$B90F</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="b90a"></a>B90A</td>
<td class="instruction">RES 7,(IY+$07)</td>
<td class="comment-11" rowspan="1">IY[7] &amp;= ~vischar_BYTE7_LOCATABLE;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="b90e"></a>B90E</td>
<td class="instruction">RET</td>
<td class="comment-11" rowspan="1">return; %&gt;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="b90f"></a>B90F</td>
<td class="instruction">INC HL</td>
<td class="comment-11" rowspan="2">else &lt;% HL[1] &amp;= ~itemstruct_ROOM_FLAG_NEARBY_6; // looks wrong: HL points to a vischar here</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="b910"></a>B910</td>
<td class="instruction">RES 6,(HL)</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="b912"></a>B912</td>
<td class="instruction">BIT 6,(HL)</td>
<td class="comment-11" rowspan="2">BIT 6,HL[1] // odd. this tests the bit we've just cleared as if we're setting flags for return. but we can't be as we're followed by another instruction.. unless DEC HL doesn't alter the Z flag .. which is true, it doesn't.</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="b914"></a>B914</td>
<td class="instruction">DEC HL</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="b915"></a>B915</td>
<td class="instruction">RET</td>
<td class="comment-11" rowspan="1">return; %&gt;</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev"><span class="prev-1">Prev: <a class="link" href="B866.html">B866</a></span></td>
<td class="up">Up: <a class="link" href="../maps/all.html#b89c">Map</a></td>
<td class="next"><span class="next-1">Next: <a class="link" href="B916.html">B916</a></span></td>
</tr>
</table>
<div class="footer">
<div class="release">The incomplete The Great Escape disassembly 20150622</div>
<div class="copyright">&copy; Denton Designs. Ocean. David Thomas.</div>
<div class="created">Created using <a class="link" href="http://skoolkit.ca/">SkoolKit</a> 4.4.</div>
</div>
</body>
</html>