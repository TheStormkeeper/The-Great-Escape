<?xml version="1.0" encoding="utf-8" ?>
<!DOCTYPE html
    PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<title>The Great Escape: Routine at F4B7</title>
<meta http-equiv="content-type" content="text/html; charset=utf-8" />
<link rel="stylesheet" type="text/css" href="../skoolkit.css" />
<link rel="stylesheet" type="text/css" href="../TheGreatEscape.css" />

</head>
<body class="Asm-c">
<table class="header">
<tr>
<td class="logo"><a class="link" href="../index.html"><img alt="logo" src="../images/logo.png" /></a></td>
<td class="page-header">Routines</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev"><span class="prev-1">Prev: <a class="link" href="F446.html">F446</a></span></td>
<td class="up">Up: <a class="link" href="../maps/all.html#f4b7">Map</a></td>
<td class="next"><span class="next-1">Next: <a class="link" href="F52C.html">F52C</a></span></td>
</tr>
</table>
<div class="description">F4B7: Runs the menu screen.</div>
<table class="disassembly">
<tr>
<td class="routine-comment" colspan="4">
<div class="details">
<div class="paragraph">
Used by the routine at <a class="link" href="F163.html">F163</a>.
</div>
<div class="paragraph">
Waits for user to select an input device, waves the morale flag and plays the title tune.
</div>
</div>
<table class="input-0">
<tr class="asm-input-header">
<th colspan="2">Input</th>
</tr>

</table>
<table class="output-0">
<tr class="asm-output-header">
<th colspan="2">Output</th>
</tr>

</table>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="f4b7"></a>F4B7</td>
<td class="instruction">CALL <a class="link" href="F271.html">$F271</a></td>
<td class="comment-11" rowspan="1">for (;;) &lt;% check_menu_keys();</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="f4ba"></a>F4BA</td>
<td class="instruction">CALL <a class="link" href="A035.html">$A035</a></td>
<td class="comment-11" rowspan="1">wave_morale_flag();</td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<a name="f4bd"></a>
<div class="comments">
<div class="paragraph">
Play music.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="f4bd"></a>F4BD</td>
<td class="instruction">LD HL,($F541)</td>
<td class="comment-11" rowspan="2">HL = music_channel0_index + 1;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="f4c0"></a>F4C0</td>
<td class="instruction">INC HL</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<a name="f4c1"></a>
<div class="comments">
<div class="paragraph">
Loop until the end marker is encountered.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="f4c1"></a>F4C1</td>
<td class="instruction">LD ($F541),HL</td>
<td class="comment-11" rowspan="1">for (;;) &lt;% music_channel0_index = HL;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="f4c4"></a>F4C4</td>
<td class="instruction">LD DE,$F546</td>
<td class="comment-11" rowspan="3">A = music_channel0_data[HL];</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="f4c7"></a>F4C7</td>
<td class="instruction">ADD HL,DE</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="f4c8"></a>F4C8</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="f4c9"></a>F4C9</td>
<td class="instruction">CP $FF</td>
<td class="comment-11" rowspan="2">if (A != 0xFF) break; /* end marker */</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="f4cb"></a>F4CB</td>
<td class="instruction">JR NZ,$F4D2</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="f4cd"></a>F4CD</td>
<td class="instruction">LD HL,$0000</td>
<td class="comment-11" rowspan="1">HL = 0;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="f4d0"></a>F4D0</td>
<td class="instruction">JR $F4C1</td>
<td class="comment-11" rowspan="1">%&gt;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="f4d2"></a>F4D2</td>
<td class="instruction">CALL <a class="link" href="F52C.html">$F52C</a></td>
<td class="comment-11" rowspan="1">get_tuning();</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="f4d5"></a>F4D5</td>
<td class="instruction">EXX</td>
<td class="comment-11" rowspan="1">-</td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<a name="f4d6"></a>
<div class="comments">
<div class="paragraph">
Loop until the end marker is encountered.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="f4d6"></a>F4D6</td>
<td class="instruction">LD HL,($F543)</td>
<td class="comment-11" rowspan="2">HLdash = music_channel1_index + 1;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="f4d9"></a>F4D9</td>
<td class="instruction">INC HL</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="f4da"></a>F4DA</td>
<td class="instruction">LD ($F543),HL</td>
<td class="comment-11" rowspan="1">for (;;) &lt;% music_channel1_index = HLdash;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="f4dd"></a>F4DD</td>
<td class="instruction">LD DE,$F7C7</td>
<td class="comment-11" rowspan="3">A = music_channel1_data[HLdash];</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="f4e0"></a>F4E0</td>
<td class="instruction">ADD HL,DE</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="f4e1"></a>F4E1</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="f4e2"></a>F4E2</td>
<td class="instruction">CP $FF</td>
<td class="comment-11" rowspan="2">if (A != 0xFF) break; /* end marker */</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="f4e4"></a>F4E4</td>
<td class="instruction">JR NZ,$F4EB</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="f4e6"></a>F4E6</td>
<td class="instruction">LD HL,$0000</td>
<td class="comment-11" rowspan="1">HLdash = 0;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="f4e9"></a>F4E9</td>
<td class="instruction">JR $F4DA</td>
<td class="comment-11" rowspan="1">%&gt;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="f4eb"></a>F4EB</td>
<td class="instruction">CALL <a class="link" href="F52C.html">$F52C</a></td>
<td class="comment-11" rowspan="1">get_tuning(); /* using banked registers */</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="f4ee"></a>F4EE</td>
<td class="instruction">LD A,B</td>
<td class="comment-11" rowspan="1">A = Bdash;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="f4ef"></a>F4EF</td>
<td class="instruction">EXX</td>
<td class="comment-11" rowspan="1">-</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="f4f0"></a>F4F0</td>
<td class="instruction">PUSH BC</td>
<td class="comment-11" rowspan="1">PUSH BC</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="f4f1"></a>F4F1</td>
<td class="instruction">CP $FF</td>
<td class="comment-11" rowspan="2">if (A == 0xFF) &lt;%</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="f4f3"></a>F4F3</td>
<td class="instruction">JR NZ,$F4FC</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="f4f5"></a>F4F5</td>
<td class="instruction">EXX</td>
<td class="comment-11" rowspan="1">-</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="f4f6"></a>F4F6</td>
<td class="instruction">POP BC</td>
<td class="comment-11" rowspan="1">POP BCdash</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="f4f7"></a>F4F7</td>
<td class="instruction">LD E,C</td>
<td class="comment-11" rowspan="2">DEdash = BCdash;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="f4f8"></a>F4F8</td>
<td class="instruction">LD D,B</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="f4f9"></a>F4F9</td>
<td class="instruction">EXX</td>
<td class="comment-11" rowspan="1">- %&gt;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="f4fa"></a>F4FA</td>
<td class="instruction">JR $F4FD</td>
<td class="comment-11" rowspan="1">else &lt;%</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="f4fc"></a>F4FC</td>
<td class="instruction">POP BC</td>
<td class="comment-11" rowspan="1">POP BC %&gt;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="f4fd"></a>F4FD</td>
<td class="instruction">LD A,$18</td>
<td class="comment-11" rowspan="1">A = 24; /* overall tune speed (a delay: lower values are faster) */</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="f4ff"></a>F4FF</td>
<td class="instruction">EX AF,AF'</td>
<td class="comment-11" rowspan="1">do &lt;% -</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="f500"></a>F500</td>
<td class="instruction">LD H,$FF</td>
<td class="comment-11" rowspan="1">H = 0xFF; /* iterations */</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="f502"></a>F502</td>
<td class="instruction">DJNZ $F510</td>
<td class="comment-11" rowspan="1">do &lt;% if (--B == 0) &lt;%</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="f504"></a>F504</td>
<td class="instruction">DEC C</td>
<td class="comment-11" rowspan="2">if (--C == 0) &lt;%</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="f505"></a>F505</td>
<td class="instruction">JP NZ,$F510</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="f508"></a>F508</td>
<td class="instruction">LD A,L</td>
<td class="comment-11" rowspan="3">L ^= 16;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="f509"></a>F509</td>
<td class="instruction">XOR $10</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="f50b"></a>F50B</td>
<td class="instruction">LD L,A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="f50c"></a>F50C</td>
<td class="instruction">OUT ($FE),A</td>
<td class="comment-11" rowspan="1">OUT ($FE),L</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="f50e"></a>F50E</td>
<td class="instruction">LD C,E</td>
<td class="comment-11" rowspan="2">BC = DE; %&gt; %&gt;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="f50f"></a>F50F</td>
<td class="instruction">LD B,D</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="f510"></a>F510</td>
<td class="instruction">EXX</td>
<td class="comment-11" rowspan="1">-</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="f511"></a>F511</td>
<td class="instruction">DJNZ $F51F</td>
<td class="comment-11" rowspan="1">if (--Bdash == 0) &lt;%</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="f513"></a>F513</td>
<td class="instruction">DEC C</td>
<td class="comment-11" rowspan="2">if (--Cdash == 0) &lt;%</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="f514"></a>F514</td>
<td class="instruction">JP NZ,$F51F</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="f517"></a>F517</td>
<td class="instruction">LD A,L</td>
<td class="comment-11" rowspan="3">Ldash ^= 16;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="f518"></a>F518</td>
<td class="instruction">XOR $10</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="f51a"></a>F51A</td>
<td class="instruction">LD L,A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="f51b"></a>F51B</td>
<td class="instruction">OUT ($FE),A</td>
<td class="comment-11" rowspan="1">OUT ($FE),Ldash</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="f51d"></a>F51D</td>
<td class="instruction">LD C,E</td>
<td class="comment-11" rowspan="2">BCdash = DEdash; %&gt; %&gt;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="f51e"></a>F51E</td>
<td class="instruction">LD B,D</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="f51f"></a>F51F</td>
<td class="instruction">EXX</td>
<td class="comment-11" rowspan="1">-</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="f520"></a>F520</td>
<td class="instruction">DEC H</td>
<td class="comment-11" rowspan="2">%&gt; while (--H);</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="f521"></a>F521</td>
<td class="instruction">JP NZ,$F502</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="f524"></a>F524</td>
<td class="instruction">EX AF,AF'</td>
<td class="comment-11" rowspan="1">-</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="f525"></a>F525</td>
<td class="instruction">DEC A</td>
<td class="comment-11" rowspan="2">%&gt; while (--A);</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="f526"></a>F526</td>
<td class="instruction">JP NZ,$F4FF</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="f529"></a>F529</td>
<td class="instruction">JP $F4B7</td>
<td class="comment-11" rowspan="1">%&gt;</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev"><span class="prev-1">Prev: <a class="link" href="F446.html">F446</a></span></td>
<td class="up">Up: <a class="link" href="../maps/all.html#f4b7">Map</a></td>
<td class="next"><span class="next-1">Next: <a class="link" href="F52C.html">F52C</a></span></td>
</tr>
</table>
<div class="footer">
<div class="release">The incomplete The Great Escape disassembly 20150622</div>
<div class="copyright">&copy; Denton Designs. Ocean. David Thomas.</div>
<div class="created">Created using <a class="link" href="http://skoolkit.ca/">SkoolKit</a> 4.4.</div>
</div>
</body>
</html>