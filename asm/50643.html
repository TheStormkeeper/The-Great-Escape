<?xml version="1.0" encoding="utf-8" ?>
<!DOCTYPE html
    PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<title>The Great Escape: Routine at C5D3</title>
<meta http-equiv="content-type" content="text/html; charset=utf-8" />
<link rel="stylesheet" type="text/css" href="../TheGreatEscape.css" />

</head>
<body class="Asm-c">
<table class="header">
<tr>
<td class="logo"><a class="link" href="../index.html"><img alt="logo" src="../images/logo.png" /></a></td>
<td class="page-header">Routines</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev"><span class="prev-1">Prev: <a class="link" href="50400.html">C4E0</a></span></td>
<td class="up">Up: <a class="link" href="../maps/all.html#50643">Map</a></td>
<td class="next"><span class="next-1">Next: <a class="link" href="50769.html">C651</a></span></td>
</tr>
</table>
<div class="description">C5D3: reset_visible_character</div>
<table class="disassembly">
<tr>
<td class="routine-comment" colspan="4">
<div class="details">
<div class="paragraph">
Reset a visible character (either a character or an object).
</div>
</div>
<table class="input-1">
<tr class="asm-input-header">
<th colspan="2">Input</th>
</tr>
<tr>
<td class="register">HL</td>
<td class="register-desc">Pointer to vischar.</td>
</tr>
</table>
<table class="output-0">
<tr class="asm-output-header">
<th colspan="2">Output</th>
</tr>

</table>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="50643"></a>C5D3</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-11" rowspan="1">A = *HL;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="50644"></a>C5D4</td>
<td class="instruction">CP $FF</td>
<td class="comment-11" rowspan="2">if (A == character_NONE) return;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="50646"></a>C5D6</td>
<td class="instruction">RET Z</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="50647"></a>C5D7</td>
<td class="instruction">CP $1A</td>
<td class="comment-11" rowspan="23">if (A &gt;= character_26_stove1) } {  HL[0] = character_NONE } HL[1] = 0xFF; // flags {  HL[7] = 0; // more flags } {  HL += 0x0F; // vischar + 0x0F } DE = &amp;movable_items[0]; // stove1 {  if (A != character_26_stove1) { } DE = &amp;movable_items[2]; // stove2 {    if (A != character_27_stove2) { } DE = &amp;movable_items[1]; } } // crate {  memcpy(DE, HL, 6); } return;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="50649"></a>C5D9</td>
<td class="instruction">JR C,$C602</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="50651"></a>C5DB</td>
<td class="instruction">EX AF,AF'</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<a name="50652"></a>
<div class="comments">
<div class="paragraph">
A stove/crate character.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="50652"></a>C5DC</td>
<td class="instruction">LD (HL),$FF</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="50654"></a>C5DE</td>
<td class="instruction">INC L</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="50655"></a>C5DF</td>
<td class="instruction">LD (HL),$FF</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="50657"></a>C5E1</td>
<td class="instruction">LD A,$06</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="50659"></a>C5E3</td>
<td class="instruction">ADD A,L</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="50660"></a>C5E4</td>
<td class="instruction">LD L,A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="50661"></a>C5E5</td>
<td class="instruction">LD (HL),$00</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="50663"></a>C5E7</td>
<td class="instruction">ADD A,$08</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="50665"></a>C5E9</td>
<td class="instruction">LD L,A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="50666"></a>C5EA</td>
<td class="instruction">EX AF,AF'</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<a name="50667"></a>
<div class="comments">
<div class="paragraph">
Save the old position.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="50667"></a>C5EB</td>
<td class="instruction">LD DE,$69AE</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="50670"></a>C5EE</td>
<td class="instruction">CP $1A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="50672"></a>C5F0</td>
<td class="instruction">JR Z,$C5FC</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="50674"></a>C5F2</td>
<td class="instruction">LD DE,$69C0</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="50677"></a>C5F5</td>
<td class="instruction">CP $1B</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="50679"></a>C5F7</td>
<td class="instruction">JR Z,$C5FC</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="50681"></a>C5F9</td>
<td class="instruction">LD DE,$69B7</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="50684"></a>C5FC</td>
<td class="instruction">LD BC,$0006</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="50687"></a>C5FF</td>
<td class="instruction">LDIR</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="50689"></a>C601</td>
<td class="instruction">RET</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="routine-comment" colspan="4">
<a name="50690"></a>
<div class="comments">
<div class="paragraph">
A non-object character.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="50690"></a>C602</td>
<td class="instruction">EX DE,HL</td>
<td class="comment-11" rowspan="1">else { -</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="50691"></a>C603</td>
<td class="instruction">CALL <a class="link" href="51129.html">$C7B9</a></td>
<td class="comment-11" rowspan="1">DE = get_character_struct(A);</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="50694"></a>C606</td>
<td class="instruction">RES 6,(HL)</td>
<td class="comment-11" rowspan="1">*DE &amp;= ~characterstruct_BYTE0_BIT6;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="50696"></a>C608</td>
<td class="instruction">LD A,$1C</td>
<td class="comment-11" rowspan="3">-</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="50698"></a>C60A</td>
<td class="instruction">ADD A,E</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="50699"></a>C60B</td>
<td class="instruction">LD E,A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="50700"></a>C60C</td>
<td class="instruction">LD A,(DE)</td>
<td class="comment-11" rowspan="1">A = HL[0x1C]; // room index</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="50701"></a>C60D</td>
<td class="instruction">INC HL</td>
<td class="comment-11" rowspan="3">*++DE = A; // characterstruct.room = room index;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="50702"></a>C60E</td>
<td class="instruction">LD (HL),A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="50703"></a>C60F</td>
<td class="instruction">EX AF,AF'</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="50704"></a>C610</td>
<td class="instruction">EX DE,HL</td>
<td class="comment-11" rowspan="1">-</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="50705"></a>C611</td>
<td class="instruction">LD A,L</td>
<td class="comment-11" rowspan="4">HL[7] = 0; // flags</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="50706"></a>C612</td>
<td class="instruction">SUB $15</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="50708"></a>C614</td>
<td class="instruction">LD L,A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="50709"></a>C615</td>
<td class="instruction">LD (HL),$00</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="50711"></a>C617</td>
<td class="instruction">ADD A,$08</td>
<td class="comment-11" rowspan="2">HL += 0x0F; // vischar+0x0F</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="50713"></a>C619</td>
<td class="instruction">LD L,A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="50714"></a>C61A</td>
<td class="instruction">INC DE</td>
<td class="comment-11" rowspan="2">DE++; // &amp;characterstruct.y</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="50715"></a>C61B</td>
<td class="instruction">EX AF,AF'</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="50716"></a>C61C</td>
<td class="instruction">AND A</td>
<td class="comment-11" rowspan="3">if (A == 0) { // outdoors } scale_pos(HL,DE); } // HL,DE updated</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="50717"></a>C61D</td>
<td class="instruction">JR NZ,$C624</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="50719"></a>C61F</td>
<td class="instruction">CALL <a class="link" href="58690.html">$E542</a></td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="50722"></a>C622</td>
<td class="instruction">JR $C62D</td>
<td class="comment-11" rowspan="1">else {</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="50724"></a>C624</td>
<td class="instruction">LD B,$03</td>
<td class="comment-11" rowspan="1">B = 3;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="50726"></a>C626</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-11" rowspan="6">do { *DE++ = *HL; } {      HL += 2; } while (--B);</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="50727"></a>C627</td>
<td class="instruction">LD (DE),A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="50728"></a>C628</td>
<td class="instruction">INC L</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="50729"></a>C629</td>
<td class="instruction">INC L</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="50730"></a>C62A</td>
<td class="instruction">INC DE</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="50731"></a>C62B</td>
<td class="instruction">DJNZ $C626</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="50733"></a>C62D</td>
<td class="instruction">LD A,L</td>
<td class="comment-11" rowspan="3">HL -= 21; // reset HL to point to original vischar</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="50734"></a>C62E</td>
<td class="instruction">SUB $15</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="50736"></a>C630</td>
<td class="instruction">LD L,A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="50737"></a>C631</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-11" rowspan="1">A = *HL; // HL points to vischar // sampled HL = $8040, $8020, $8080, $80A0</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="50738"></a>C632</td>
<td class="instruction">LD (HL),$FF</td>
<td class="comment-11" rowspan="2">*HL++ = character_NONE;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="50740"></a>C634</td>
<td class="instruction">INC L</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="50741"></a>C635</td>
<td class="instruction">LD (HL),$FF</td>
<td class="comment-11" rowspan="2">*HL++ = 0xFF; // flags</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="50743"></a>C637</td>
<td class="instruction">INC L</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="50744"></a>C638</td>
<td class="instruction">CP $10</td>
<td class="comment-11" rowspan="11">if (A &gt;= character_16 &amp;&amp; A &lt; character_20_prisoner) { } {    *HL++ = 255; } *HL = 0; {    if (A &gt;= character_18_prisoner) *HL = 24; } HL--;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="50746"></a>C63A</td>
<td class="instruction">JR C,$C64C</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="50748"></a>C63C</td>
<td class="instruction">CP $14</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="50750"></a>C63E</td>
<td class="instruction">JR NC,$C64C</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="50752"></a>C640</td>
<td class="instruction">LD (HL),$FF</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="50754"></a>C642</td>
<td class="instruction">INC L</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="50755"></a>C643</td>
<td class="instruction">LD (HL),$00</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="50757"></a>C645</td>
<td class="instruction">CP $12</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="50759"></a>C647</td>
<td class="instruction">JR C,$C64B</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="50761"></a>C649</td>
<td class="instruction">LD (HL),$18</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="50763"></a>C64B</td>
<td class="instruction">DEC L</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-2"><a name="50764"></a>C64C</td>
<td class="instruction">LDI</td>
<td class="comment-11" rowspan="1">*DE++ = *HL++; // copy target into charstruct</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="50766"></a>C64E</td>
<td class="instruction">LDI</td>
<td class="comment-11" rowspan="1">*DE++ = *HL++;</td>
</tr>
<tr>
<td class="asm-label-0"></td>
<td class="address-1"><a name="50768"></a>C650</td>
<td class="instruction">RET</td>
<td class="comment-11" rowspan="1">return; }</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev"><span class="prev-1">Prev: <a class="link" href="50400.html">C4E0</a></span></td>
<td class="up">Up: <a class="link" href="../maps/all.html#50643">Map</a></td>
<td class="next"><span class="next-1">Next: <a class="link" href="50769.html">C651</a></span></td>
</tr>
</table>
<div class="footer">
<div class="release">The incomplete The Great Escape disassembly 20140530</div>
<div class="copyright">&copy; Denton Designs. Ocean. David Thomas.</div>
<div class="created">Created using <a class="link" href="http://pyskool.ca/?page_id=177">SkoolKit</a> 4.0.</div>
</div>
</body>
</html>